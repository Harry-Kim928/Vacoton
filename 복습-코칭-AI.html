<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision AI 복습 코칭 - 이미지 개념 분석 & 심화 질문 생성</title>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 30px;
            min-height: 500px;
        }

        /* API 키 설정 섹션 */
        .api-setup {
            background: #f8fafc;
            border: 2px dashed #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
        }

        .api-setup h3 {
            color: #374151;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .api-setup p {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .api-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .api-input:focus {
            border-color: #4f46e5;
        }

        .api-button {
            padding: 12px 20px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .api-button:hover {
            background: #4338ca;
        }

        /* 개념 입력 섹션 */
        .concept-setup {
            background: #f0f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            display: none;
        }

        .concept-setup h3 {
            color: #0f172a;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .concept-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #bae6fd;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            margin-bottom: 15px;
            resize: vertical;
            min-height: 100px;
        }

        .concept-input:focus {
            border-color: #0ea5e9;
        }

        /* 이미지 업로드 섹션 */
        .upload-section {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #0ea5e9;
            background: #f0f9ff;
        }

        .upload-section.dragover {
            border-color: #0ea5e9;
            background: #e0f2fe;
            transform: scale(1.02);
        }

        .upload-button {
            background: #0ea5e9;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px;
            transition: background 0.3s;
        }

        .upload-button:hover {
            background: #0284c7;
        }

        .upload-text {
            color: #64748b;
            margin: 10px 0;
            font-size: 14px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .ocr-progress {
            background: #f1f5f9;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .ocr-status {
            color: #475569;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .progress-bar-ocr {
            background: #e2e8f0;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill-ocr {
            background: linear-gradient(90deg, #06b6d4, #0ea5e9);
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .start-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #0ea5e9, #3b82f6);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .start-button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 퀴즈 섹션 */
        .quiz-section {
            display: none;
        }

        .progress-bar {
            background: #e5e7eb;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 25px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, #10b981, #059669);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .question-card {
            background: #fefefe;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            background: #4f46e5;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .question-text {
            font-size: 18px;
            line-height: 1.6;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 15px;
        }

        .answer-input:focus {
            border-color: #4f46e5;
        }

        .submit-answer-button {
            padding: 12px 24px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .submit-answer-button:hover {
            background: #047857;
        }

        .submit-answer-button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .feedback-card {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .feedback-text {
            line-height: 1.6;
            color: #0f172a;
            margin-bottom: 15px;
        }

        .next-button {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .next-button:hover {
            background: #4338ca;
        }

        /* 완료 섹션 */
        .completion-section {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .completion-section h3 {
            color: #059669;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .completion-section p {
            color: #6b7280;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        .restart-button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .restart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }

        /* 로딩 애니메이션 */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
        }

        .loading-dots {
            display: flex;
            gap: 3px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: #6b7280;
            border-radius: 50%;
            animation: loading 1.4s infinite;
        }

        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes loading {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        .error-message {
            background: #fef2f2;
            border: 2px solid #fecaca;
            color: #b91c1c;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .api-input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Vision AI 복습 코칭</h1>
            <p>AI가 이미지를 보고 개념을 파악하여 심화 사고 질문을 생성합니다</p>
        </div>

        <div class="content">
            <!-- API 키 설정 섹션 -->
            <div class="api-setup" id="apiSetup">
                <h3>🔑 OpenAI API 키 설정</h3>
                <p>Vision AI 이미지 분석을 위해 OpenAI API 키를 입력해주세요.<br>
                   <small style="color: #9ca3af;">GPT-4o-mini Vision으로 이미지를 분석하고 개념을 파악합니다.<br>
                   API 키는 브라우저에만 저장되며 외부로 전송되지 않습니다.</small></p>
                <div class="api-input-group">
                    <input type="password" id="apiKeyInput" class="api-input" placeholder="sk-..." />
                    <button onclick="setApiKey()" class="api-button">설정하기</button>
                </div>
                <div id="apiError" class="error-message" style="display: none;"></div>
            </div>

            <!-- 개념 입력 섹션 -->
            <div class="concept-setup" id="conceptSetup">
                <h3>📚 심화 사고력 평가할 학습 내용을 입력하세요</h3>
                
                <!-- 이미지 업로드 섹션 -->
                <div class="upload-section" id="uploadSection">
                    <div>🧠 AI가 이미지를 보고 개념을 분석합니다</div>
                    <div class="upload-text">
                        교과서, 노트, 문제집 사진을 업로드하세요<br>
                        <small>Vision AI가 수학 개념을 파악하고 맥락을 이해합니다 (최대 10MB)</small>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    <button onclick="document.getElementById('imageInput').click()" class="upload-button">
                        📁 이미지 선택
                    </button>
                    <button onclick="clearImage()" class="upload-button" style="background: #64748b;">
                        🗑️ 초기화
                    </button>
                </div>

                <!-- OCR 진행 상황 -->
                <div class="ocr-progress" id="ocrProgress">
                    <div class="ocr-status" id="ocrStatus">AI가 이미지를 분석하고 있어요...</div>
                    <div class="progress-bar-ocr">
                        <div class="progress-fill-ocr" id="ocrProgressFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 이미지 미리보기 -->
                <div id="imagePreviewContainer" style="display: none;">
                    <img id="imagePreview" class="image-preview">
                </div>

                <textarea id="conceptInput" class="concept-input" placeholder="위에서 교과서나 노트 이미지를 업로드하면
AI가 자동으로 수학 개념을 분석하여 여기에 표시됩니다.

또는 직접 학습 내용을 입력할 수도 있습니다.
예: 미분의 정의와 성질, 이차함수의 그래프, 삼각함수의 덧셈공식 등"></textarea>
                <button onclick="startQuiz()" class="start-button" id="startButton">
                    🧠 심화 사고력 평가 시작
                </button>
                <div id="conceptError" class="error-message" style="display: none;"></div>
            </div>

            <!-- 퀴즈 진행 섹션 -->
            <div class="quiz-section" id="quizSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>

                <div class="question-card">
                    <div class="question-header">
                        <span class="question-number" id="questionNumber">질문 1/6</span>
                    </div>
                    <div class="question-text" id="questionText">
                        질문을 불러오는 중입니다...
                    </div>
                    <textarea id="answerInput" class="answer-input" placeholder="여기에 답변을 입력해주세요..."></textarea>
                    <button onclick="submitAnswer()" class="submit-answer-button" id="submitButton">
                        답변 제출
                    </button>
                </div>

                <div class="feedback-card" id="feedbackCard">
                    <div class="feedback-text" id="feedbackText"></div>
                    <button onclick="nextQuestion()" class="next-button" id="nextButton">
                        다음 질문
                    </button>
                </div>
            </div>

            <!-- 완료 섹션 -->
            <div class="completion-section" id="completionSection">
                <h3>🏆 심화 사고력 평가 완료!</h3>
                <p>모든 고급 응용 질문을 완료했습니다. 훌륭해요!<br>
                   정기적인 심화 학습으로 사고력을 더욱 발전시켜보세요.</p>
                <button onclick="restartQuiz()" class="restart-button">
                    새로운 심화 평가 시작하기
                </button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let apiKey = '';
        let questions = [];
        let currentQuestionIndex = 0;
        let userConcept = '';
        let isOCRProcessing = false;

        // API 키 설정
        function setApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (!key) {
                showError('apiError', 'API 키를 입력해주세요!');
                return;
            }
            
            if (!key.startsWith('sk-')) {
                showError('apiError', 'OpenAI API 키가 올바르지 않아요. sk-로 시작해야 해요.');
                return;
            }
            
            apiKey = key;
            localStorage.setItem('openai_api_key', key);
            
            // API 키 섹션 숨기고 개념 입력 섹션 표시
            document.getElementById('apiSetup').style.display = 'none';
            document.getElementById('conceptSetup').style.display = 'block';
            document.getElementById('conceptInput').focus();
        }

        // 이미지 업로드 및 AI 분석 기능
        function handleImageUpload(file) {
            if (!file || !file.type.startsWith('image/')) {
                showError('conceptError', '이미지 파일만 올릴 수 있어요!');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB 제한
                showError('conceptError', '파일이 너무 커요. 10MB 이하로 올려주세요.');
                return;
            }

            // 이미지 미리보기 표시
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                const container = document.getElementById('imagePreviewContainer');
                preview.src = e.target.result;
                container.style.display = 'block';
                
                // API 키가 있으면 Vision API로 개념 분석, 없으면 OCR
                if (apiKey) {
                    analyzeImageConcept(file);
                } else {
                    showError('conceptError', 'AI 이미지 분석을 위해 먼저 API 키를 설정해주세요!');
                    performOCR(file); // 백업으로 OCR 사용
                }
            };
            reader.readAsDataURL(file);
        }

        // Vision API로 이미지 개념 분석 (메인 기능)
        async function analyzeImageConcept(file) {
            if (isOCRProcessing) return;
            
            isOCRProcessing = true;
            const progressElement = document.getElementById('ocrProgress');
            const statusElement = document.getElementById('ocrStatus');
            const progressFill = document.getElementById('ocrProgressFill');
            
            progressElement.style.display = 'block';
            progressFill.style.width = '0%';
            statusElement.textContent = 'AI가 이미지를 보고 개념을 파악하고 있어요...';
            
            try {
                const base64Image = await fileToBase64(file);
                progressFill.style.width = '30%';
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: `이 이미지에서 어떤 수학 개념을 학습하고 있는지 분석해주세요.

교과서, 노트, 또는 문제집에서 가져온 이미지인 것 같은데, 단순한 계산 문제가 아니라 어떤 수학적 개념이나 원리를 배우는 내용인지 파악해주세요.

다음과 같이 분석해주세요:

**핵심 개념**: 이 이미지에서 다루는 주요 수학 개념이 무엇인가요?

**학습 내용**: 이 개념에 대해 구체적으로 어떤 내용을 다루고 있나요? (공식, 정리, 성질 등)

**학습 목표**: 학생이 이 내용을 통해 무엇을 이해해야 하는지, 왜 이 개념이 중요한지 설명해주세요.

그래프, 도표, 공식의 배치 등 시각적 요소도 함께 고려해서 교육적 맥락을 파악해주세요. 단순히 "6²-5²+1을 계산하세요" 같은 계산 문제라면, 그 뒤에 숨어있는 수학적 원리(예: 완전제곱수의 차, 인수분해 등)가 무엇인지 찾아주세요.`
                                    },
                                    {
                                        type: 'image_url',
                                        image_url: {
                                            url: base64Image
                                        }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1500
                    })
                });

                progressFill.style.width = '70%';
                statusElement.textContent = '개념 분석 결과를 정리하고 있어요...';

                if (!response.ok) {
                    throw new Error(`Vision API 실패: ${response.status}`);
                }

                const data = await response.json();
                const analysisResult = data.choices[0].message.content.trim();
                
                progressFill.style.width = '100%';
                statusElement.textContent = '✅ 개념 분석 완료! 이제 질문을 만들 수 있어요';

                // 개념 분석 결과를 입력창에 추가
                const conceptInput = document.getElementById('conceptInput');
                const currentText = conceptInput.value.trim();
                
                if (currentText) {
                    conceptInput.value = currentText + '\n\n=== AI 분석 결과 ===\n' + analysisResult;
                } else {
                    conceptInput.value = analysisResult;
                }
                
                // 3초 후 진행바 숨기기
                setTimeout(() => {
                    progressElement.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                console.error('Vision Analysis Error:', error);
                statusElement.textContent = '❌ 분석에 실패했어요. 다시 시도해볼게요';
                showError('conceptError', 'AI 분석이 잘 안 되네요. 다른 방법으로 시도해볼게요.');
                
                // 실패 시 OCR로 대체
                setTimeout(() => {
                    performOCR(file);
                }, 1000);
            }
            
            isOCRProcessing = false;
        }

        // OCR 텍스트 인식 수행
        async function performOCR(file) {
            if (isOCRProcessing) return;
            
            isOCRProcessing = true;
            const progressElement = document.getElementById('ocrProgress');
            const statusElement = document.getElementById('ocrStatus');
            const progressFill = document.getElementById('ocrProgressFill');
            
            progressElement.style.display = 'block';
            progressFill.style.width = '0%';
            
            try {
                statusElement.textContent = 'OCR 엔진 초기화 중...';
                
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'kor+eng', // 한국어 + 영어 인식
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                progressFill.style.width = `${progress}%`;
                                statusElement.textContent = `텍스트 인식 중... ${progress}%`;
                            }
                        },
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO_OSD,
                        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz가-힣+-*/=()[]{}^√∞∑∫≤≥≠→←↑↓°′″αβγδεζηθικλμνξοπρστυφχψω∀∃∈∉⊂⊃∪∩∅ℝℂℕℤℚ∴∵∝∼≅≡∝∠⊥∥⟂△▲▼▶◀●○■□★☆',
                        preserve_interword_spaces: '1'
                    }
                );
                
                statusElement.textContent = '수학 기호 후처리 중...';
                
                // 수학 기호 후처리
                let cleanedText = text
                    .replace(/"/g, '²')  // " → ²
                    .replace(/'/g, '′')  // ' → ′ (프라임)
                    .replace(/—/g, '-')  // — → -
                    .replace(/–/g, '-')  // – → -
                    .replace(/\|/g, '1')  // | → 1 (종종 1이 |로 인식됨)
                    .replace(/O/g, '0')   // O → 0 (영문 O가 숫자 0일 가능성)
                    .replace(/l/g, '1')   // l → 1 (소문자 l이 숫자 1일 가능성)
                    .replace(/\s*x\s*/g, '×')  // x → × (곱셈 기호)
                    .replace(/\s*\*\s*/g, '×')  // * → ×
                    .replace(/\/\s*/g, '÷')     // / → ÷
                    .replace(/<=|≤/g, '≤')      // <= → ≤
                    .replace(/>=|≥/g, '≥')      // >= → ≥
                    .replace(/!=/g, '≠')        // != → ≠
                    .replace(/\s+/g, ' ')       // 여러 공백을 하나로
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .join('\n');
                
                // GPT Vision API 사용 옵션 추가 (API 키가 있는 경우)
                if (apiKey && cleanedText.length < 50) {
                    statusElement.textContent = 'AI 이미지 분석으로 재시도 중...';
                    try {
                        const aiExtractedText = await extractTextWithGPTVision(file);
                        if (aiExtractedText && aiExtractedText.length > cleanedText.length) {
                            cleanedText = aiExtractedText;
                            statusElement.textContent = '✅ AI 이미지 분석 완료!';
                        }
                    } catch (visionError) {
                        console.log('Vision API 실패, OCR 결과 사용:', visionError);
                    }
                }
                
                if (cleanedText.trim()) {
                    // 개념 입력창에 텍스트 추가
                    const conceptInput = document.getElementById('conceptInput');
                    const currentText = conceptInput.value.trim();
                    
                    if (currentText) {
                        conceptInput.value = currentText + '\n\n' + cleanedText;
                    } else {
                        conceptInput.value = cleanedText;
                    }
                    
                    if (!statusElement.textContent.includes('AI 이미지 분석')) {
                        statusElement.textContent = '✅ 텍스트 인식 완료!';
                    }
                    progressFill.style.width = '100%';
                    
                    // 3초 후 진행바 숨기기
                    setTimeout(() => {
                        progressElement.style.display = 'none';
                    }, 3000);
                    
                } else {
                    throw new Error('텍스트를 인식할 수 없습니다.');
                }
                
            } catch (error) {
                console.error('OCR Error:', error);
                statusElement.textContent = '❌ 텍스트를 읽을 수 없어요';
                showError('conceptError', '이미지에서 글자를 읽기 어려워요. 더 선명한 사진을 사용하거나 직접 입력해주세요.');
                
                setTimeout(() => {
                    progressElement.style.display = 'none';
                }, 3000);
            }
            
            isOCRProcessing = false;
        }

        // GPT Vision API로 텍스트 추출 (보조 기능)
        async function extractTextWithGPTVision(file) {
            const base64Image = await fileToBase64(file);
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: '이 이미지에서 수학 공식, 개념, 문제 등의 텍스트를 정확히 추출해주세요. 수학 기호는 올바른 유니코드로 변환하고, 줄바꿈과 공백을 적절히 유지해주세요. 텍스트만 추출하고 추가 설명은 하지 마세요.'
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 1000
                })
            });

            if (!response.ok) {
                throw new Error(`Vision API 실패: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }

        // 파일을 Base64로 변환
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 이미지 초기화
        function clearImage() {
            document.getElementById('imageInput').value = '';
            document.getElementById('imagePreviewContainer').style.display = 'none';
            document.getElementById('ocrProgress').style.display = 'none';
        }

        // 퀴즈 시작
        async function startQuiz() {
            const conceptInput = document.getElementById('conceptInput');
            const concept = conceptInput.value.trim();
            
            if (!concept) {
                showError('conceptError', '학습 내용을 입력해주세요!');
                return;
            }
            
            userConcept = concept;
            
            // 로딩 상태
            const startButton = document.getElementById('startButton');
            const originalText = startButton.innerHTML;
            startButton.innerHTML = '<span class="loading">맞춤 질문 만드는 중<div class="loading-dots"><span></span><span></span><span></span></div></span>';
            startButton.disabled = true;
            
            try {
                // GPT API로 질문 생성
                questions = await generateQuestions(concept);
                
                if (questions.length === 0) {
                    throw new Error('질문 생성에 실패했습니다.');
                }
                
                // 퀴즈 섹션으로 이동
                document.getElementById('conceptSetup').style.display = 'none';
                document.getElementById('quizSection').style.display = 'block';
                
                // 첫 번째 질문 표시
                currentQuestionIndex = 0;
                displayQuestion();
                
            } catch (error) {
                console.error('Error starting quiz:', error);
                showError('conceptError', '질문을 만드는 중에 문제가 생겼어요. API 키를 확인해주세요.');
                startButton.innerHTML = originalText;
                startButton.disabled = false;
            }
        }

        // GPT API로 질문 생성
        async function generateQuestions(concept) {
            const prompt = `당신은 고등학생과 대화하는 수학 선생님입니다. 아래 학습 내용을 바탕으로 개념 이해를 확인하는 질문을 만드세요.

**학습 내용:**
${concept}

**❌ 최대한 포함하지 마세요:**
- 수식 중심 질문 (예: lim f(x) = L 같은 형식)
- 단순 계산 문제
- 단어 정의 묻기

**✅ 반드시 반영해야 할 조건 중 2가지 이상 포함된 질문을 4~6개 생성하세요:**
1. **개념 구분/비교:** 비슷하거나 혼동하기 쉬운 개념 간의 차이를 설명하게 만드세요.
2. **조건 탐색:** 개념이 성립하는 조건과 예외 상황을 따지게 하세요.
3. **오개념 유도:** 흔히 잘못 이해하는 부분을 의도적으로 지적하게 하세요.
4. **반례 요청:** 항상 성립하지 않는 상황을 찾게 하세요.
5. **설명형 질문:** 상황을 설명하거나 본인의 말로 정리하게 하세요.

**수식 없이 질문하세요. 수학 개념은 상황과 언어로 설명하게 유도하세요.**

**좋은 질문 예시:**
- "극한값이 존재하지 않더라도 좌극한과 우극한은 존재할 수 있나요? 그 이유는요?"
- "두 함수가 각각 극한을 가지는데, 두 함수를 곱하면 극한이 없어질 수도 있나요?"
- "극한이 존재하는 함수와 연속인 함수는 어떻게 다르죠?"
- "함수값이 존재해도 극한값이 존재하지 않을 수 있다는 건 무슨 뜻일까요?"

**응답 형식:**
1. [질문1]
2. [질문2]
3. [질문3]
4. [질문4]
5. [질문5]
6. [질문6]

각 질문은 학생이 개념을 말로 설명하고, 비교하고, 예외 상황을 찾아보게 만드는 질문이어야 합니다.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 호출 실패: ${response.status}`);
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // 질문 추출
                const questionLines = content.split('\n').filter(line => 
                    line.trim() && /^\d+\./.test(line.trim())
                );
                
                return questionLines.map(line => line.replace(/^\d+\.\s*/, '').trim());
                
            } catch (error) {
                console.error('GPT API Error:', error);
                throw error;
            }
        }

        // 질문 표시
        function displayQuestion() {
            const questionNumberElement = document.getElementById('questionNumber');
            const questionTextElement = document.getElementById('questionText');
            const answerInput = document.getElementById('answerInput');
            const feedbackCard = document.getElementById('feedbackCard');
            
            // 진행률 업데이트
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            // 질문 표시
            questionNumberElement.textContent = `질문 ${currentQuestionIndex + 1}/${questions.length}`;
            questionTextElement.textContent = questions[currentQuestionIndex];
            
            // 입력 필드 초기화
            answerInput.value = '';
            answerInput.focus();
            
            // 피드백 카드 숨기기
            feedbackCard.style.display = 'none';
            
            // 제출 버튼 활성화
            document.getElementById('submitButton').disabled = false;
        }

        // 답변 제출
        async function submitAnswer() {
            const answerInput = document.getElementById('answerInput');
            const answer = answerInput.value.trim();
            
            if (!answer) {
                alert('답변을 써주세요!');
                return;
            }
            
            // 로딩 상태
            const submitButton = document.getElementById('submitButton');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<span class="loading">답변 확인하는 중<div class="loading-dots"><span></span><span></span><span></span></div></span>';
            submitButton.disabled = true;
            
            try {
                // GPT API로 피드백 생성
                const feedback = await generateFeedback(questions[currentQuestionIndex], answer);
                
                // 피드백 표시
                document.getElementById('feedbackText').innerHTML = feedback;
                document.getElementById('feedbackCard').style.display = 'block';
                
                // 마지막 질문인지 확인
                const nextButton = document.getElementById('nextButton');
                if (currentQuestionIndex === questions.length - 1) {
                    nextButton.textContent = '복습 완료';
                } else {
                    nextButton.textContent = '다음 질문';
                }
                
            } catch (error) {
                console.error('Error generating feedback:', error);
                alert('답변을 확인하는 중에 문제가 생겼어요. 다시 시도해주세요.');
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        }

        // GPT API로 피드백 생성
        async function generateFeedback(question, answer) {
            const prompt = `당신은 친근한 수학 선생님입니다. 학생의 답변을 보고 자연스럽고 도움이 되는 피드백을 주세요.

**학생이 답한 질문:** ${question}
**학생 답변:** ${answer}

**피드백 스타일:**
- 고등학생과 대화하듯 친근하고 자연스럽게
- 잘한 부분은 먼저 인정하고 격려
- 틀린 부분은 "아, 여기서 조금 헷갈렸구나" 식으로 부드럽게 지적
- 복잡한 용어나 평가 기준은 언급하지 말고 직관적으로 설명
- 학생이 스스로 깨달을 수 있도록 힌트 제공

**좋은 피드백 예시:**
"오, 기본 개념은 잘 이해하고 있네! 다만 여기서 한 가지 놓친 부분이 있는데..."
"맞아, 그 부분은 정말 잘 설명했어. 그런데 만약 이런 경우라면 어떨까?"
"아하, 그렇게 생각할 수도 있겠다. 하지만 조금 다른 관점에서 보면..."

**응답 형식:**
자연스러운 대화체로 3-5문장 정도의 피드백을 작성하세요. 
학생이 "아, 그렇구나!" 하고 이해할 수 있도록 친근하게 설명해주세요.

형식적인 평가 점수나 항목별 분석은 하지 마세요. 그냥 선생님이 학생과 이야기하듯 자연스럽게 피드백하세요.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 호출 실패: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.replace(/\n/g, '<br>');
                
            } catch (error) {
                console.error('GPT API Error:', error);
                throw error;
            }
        }

        // 다음 질문으로 이동
        function nextQuestion() {
            currentQuestionIndex++;
            
            if (currentQuestionIndex >= questions.length) {
                // 모든 질문 완료
                document.getElementById('quizSection').style.display = 'none';
                document.getElementById('completionSection').style.display = 'block';
            } else {
                // 다음 질문 표시
                displayQuestion();
            }
        }

        // 퀴즈 재시작
        function restartQuiz() {
            // 모든 섹션 초기화
            document.getElementById('completionSection').style.display = 'none';
            document.getElementById('conceptSetup').style.display = 'block';
            
            // 데이터 초기화
            questions = [];
            currentQuestionIndex = 0;
            document.getElementById('conceptInput').value = '';
            document.getElementById('conceptInput').focus();
        }

        // 에러 메시지 표시
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Enter 키 이벤트 처리
        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                const activeElement = document.activeElement;
                
                if (activeElement.id === 'apiKeyInput') {
                    event.preventDefault();
                    setApiKey();
                } else if (activeElement.id === 'conceptInput') {
                    event.preventDefault();
                    startQuiz();
                } else if (activeElement.id === 'answerInput') {
                    event.preventDefault();
                    submitAnswer();
                }
            }
        });

        // 페이지 로드 시 저장된 API 키 확인
        document.addEventListener('DOMContentLoaded', function() {
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKeyInput').value = savedApiKey;
                apiKey = savedApiKey;
                document.getElementById('apiSetup').style.display = 'none';
                document.getElementById('conceptSetup').style.display = 'block';
                document.getElementById('conceptInput').focus();
            }

            // 이미지 업로드 이벤트 리스너
            const imageInput = document.getElementById('imageInput');
            const uploadSection = document.getElementById('uploadSection');

            // 파일 선택 이벤트
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            });

            // 드래그 앤 드롭 이벤트
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                uploadSection.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        handleImageUpload(file);
                    } else {
                        showError('conceptError', '이미지 파일만 올릴 수 있어요!');
                    }
                }
            });

            // 업로드 섹션 클릭 시 파일 선택
            uploadSection.addEventListener('click', function(e) {
                if (e.target === uploadSection || e.target.closest('.upload-text')) {
                    imageInput.click();
                }
            });
        });
    </script>
</body>
</html>