<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision AI 복습 코칭 - 채팅형 학습</title>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    
    <!-- MathJax for LaTeX rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* 헤더 */
        .chat-header {
            background: #f97316;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
        }

        .chat-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-left: 10px;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .question-counter {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .next-question-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .next-question-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .next-question-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tutor-profile {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            overflow: hidden;
        }
        
        .tutor-profile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 채팅 영역 */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* 말풍선 공통 스타일 - 완전 새로 작성 */
        .message {
            display: flex !important;
            margin-bottom: 20px !important;
            animation: fadeInUp 0.3s ease-out;
            max-width: 100% !important;
            padding: 0 16px !important;
            width: 100% !important;
        }

        .message.ai {
            justify-content: flex-start !important;
            align-items: flex-start !important;
            flex-direction: row !important;
        }

        .message.user {
            justify-content: flex-end !important;
            align-items: flex-start !important;
            flex-direction: row-reverse !important;
        }

        .message-bubble {
            max-width: 70% !important;
            padding: 12px 16px 32px 16px !important;
            border-radius: 18px !important;
            position: relative !important;
            word-wrap: break-word !important;
            line-height: 1.4 !important;
            word-break: break-word !important;
            overflow-wrap: break-word !important;
            flex-shrink: 1 !important;
        }

        /* AI 튜터 말풍선 (왼쪽, 회색) */
        .message.ai .message-bubble {
            background: #e5e7eb !important;
            color: #374151 !important;
            border-bottom-left-radius: 8px !important;
            margin-left: 0 !important;
            position: relative !important;
            align-self: flex-start !important;
            margin-right: auto !important;
            flex-shrink: 1 !important;
        }

        .message.ai .avatar {
            width: 32px !important;
            height: 32px !important;
            background: #4f46e5 !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: white !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            margin-right: 8px !important;
            align-self: flex-start !important;
            overflow: hidden !important;
            flex-shrink: 0 !important;
            min-width: 32px !important;
            min-height: 32px !important;
            max-width: 32px !important;
            max-height: 32px !important;
            box-sizing: border-box !important;
        }
        
        .message.ai .avatar img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            border-radius: 50% !important;
            flex-shrink: 0 !important;
            max-width: 100% !important;
            max-height: 100% !important;
            box-sizing: border-box !important;
            display: block !important;
        }

        /* 학생 말풍선 (오른쪽, 파란색) */
        .message.user .message-bubble {
            background: #3b82f6 !important;
            color: white !important;
            border-bottom-right-radius: 8px !important;
            margin-right: 0 !important;
            align-self: flex-end !important;
            flex-shrink: 1 !important;
        }

        .message.user .avatar {
            width: 32px;
            height: 32px;
            background: #60a5fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-left: 8px;
            align-self: flex-start;
            flex-shrink: 0;
            min-width: 32px;
            min-height: 32px;
        }

        /* 시간 표시 - 강제 적용 */
        .message-time {
            position: absolute !important;
            bottom: 4px !important;
            right: 8px !important;
            font-size: 10px !important;
            text-align: right !important;
            z-index: 10 !important;
        }

        .message.ai .message-time {
            color: #9ca3af !important;
        }

        .message.user .message-time {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* 특별한 메시지 스타일 */
        .system-message {
            text-align: center;
            margin: 20px 0;
        }

        .system-message .message-bubble {
            background: #f3f4f6;
            color: #6b7280;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 13px;
            display: inline-block;
            max-width: 80%;
        }

        /* 이미지 미리보기 */
        .image-preview-message {
            max-width: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .image-preview-message img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* 버튼 스타일 */
        .inline-button {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 8px 4px 0 0;
            transition: background 0.2s;
        }

        .inline-button:hover {
            background: #4338ca;
        }

        .inline-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* 하단 입력 영역 */
        .chat-input-container {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 15px 20px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 22px;
            padding: 12px 50px 12px 16px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 44px;
            line-height: 1.4;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: #4f46e5;
        }

        .chat-input:disabled {
            background-color: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .input-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 4px;
        }

        .input-button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .input-button:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .input-button.primary {
            background: #4f46e5;
            color: white;
        }

        .input-button.primary:hover {
            background: #4338ca;
        }

        .input-button:disabled {
            background: #f9fafb;
            color: #d1d5db;
            cursor: not-allowed;
        }

        /* 학습 마치기 버튼 */
        .finish-learning-container {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        }

        .finish-learning-btn {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .finish-learning-btn:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .finish-learning-btn:disabled {
            background: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        /* 로딩 애니메이션 */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 숨겨진 요소들 */
        .hidden {
            display: none !important;
        }

        /* 진행률 표시 */
        .progress-message {
            text-align: center;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 12px;
            margin: 16px;
            color: #0ea5e9;
            font-weight: 500;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            /* 헤더 최적화 */
            .chat-header {
                padding: 10px 12px;
            }
            
            .chat-header h1 {
                font-size: 16px;
            }
            
            .tutor-profile {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            
            /* 채팅 메시지 최적화 */
            .chat-messages {
                padding: 12px;
            }
            
            .message {
                margin-bottom: 16px;
                padding: 0 12px;
            }
            
            .message-bubble {
                max-width: 85%;
                padding: 10px 14px 28px 14px;
                font-size: 14px;
                line-height: 1.3;
            }
            
            /* 아바타 크기 최적화 */
            .message.ai .avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
                margin-right: 6px;
                flex-shrink: 0;
                min-width: 28px;
                min-height: 28px;
                align-self: flex-start;
            }
            
            .message.user .avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
                margin-left: 6px;
                flex-shrink: 0;
                min-width: 28px;
                min-height: 28px;
            }
            
            /* 시간 표시 최적화 */
            .message-time {
                font-size: 10px;
                margin-top: 3px;
            }
            
            .message.ai .message-time {
                bottom: 2px;
                right: 6px;
                font-size: 9px;
            }
            
            .message-time {
                bottom: 2px;
                right: 6px;
                font-size: 9px;
            }
            
            /* 입력창 최적화 */
            .chat-input-container {
                padding: 10px 12px;
            }
            
            .chat-input {
                padding: 10px 45px 10px 14px;
                font-size: 14px;
                min-height: 40px;
            }
            
            .input-button {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            /* 시스템 메시지 최적화 */
            .system-message .message-bubble {
                font-size: 12px;
                padding: 6px 12px;
            }
            
            /* 이미지 미리보기 최적화 */
            .image-preview-message {
                max-width: 250px;
            }
            
            /* 학습 마치기 버튼 최적화 */
            .finish-learning-container {
                padding: 12px 15px;
            }
            
            .finish-learning-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        /* 작은 모바일 화면 추가 최적화 */
        @media (max-width: 480px) {
            .message {
                padding: 0 8px;
            }
            
            .message-bubble {
                max-width: 90%;
                padding: 8px 12px 24px 12px;
                font-size: 13px;
            }
            
            .chat-header h1 {
                font-size: 15px;
            }
            
            .tutor-profile {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .message.ai .avatar {
                width: 24px;
                height: 24px;
                font-size: 10px;
                margin-right: 4px;
                flex-shrink: 0;
                min-width: 24px;
                min-height: 24px;
            }
            
            .message.user .avatar {
                width: 24px;
                height: 24px;
                font-size: 10px;
                margin-left: 4px;
                flex-shrink: 0;
                min-width: 24px;
                min-height: 24px;
            }
            
            .message-time {
                bottom: 1px;
                right: 4px;
                font-size: 8px;
            }
        }

        /* 파일 업로드 숨김 */
        .file-input-hidden {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        /* API 키 설정 모달 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1f2937;
        }

        .modal-description {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            outline: none;
            margin-bottom: 16px;
            font-family: inherit;
        }

        .modal-input:focus {
            border-color: #4f46e5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-button.primary {
            background: #4f46e5;
            color: white;
        }

        .modal-button.primary:hover {
            background: #4338ca;
        }

        .modal-button.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-button.secondary:hover {
            background: #e5e7eb;
        }

        /* 에러 메시지 */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        /* 질문 구분선 */
        .question-divider {
            text-align: center;
            margin: 30px 0 20px 0;
            position: relative;
        }

        .question-divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
            z-index: 1;
        }

        .question-divider-text {
            background: #f5f5f5;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            position: relative;
            z-index: 2;
            display: inline-block;
        }


    </style>
</head>
<body>
    <!-- 헤더 -->
    <div class="chat-header">
        <div class="chat-header-left">
            <div class="tutor-profile">
                <img src="ai-tutor-profile.png" alt="콴다 AI 복습 코치" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
            </div>
            <h1>콴다 AI 복습 코치</h1>
        </div>
        <div class="chat-header-right">
            <div class="question-counter" id="questionCounter">추가 질문 제한 (0/5)</div>
            <button class="next-question-btn" id="nextQuestionBtn" disabled>다음 질문</button>
        </div>
    </div>

    <!-- 채팅 컨테이너 -->
    <div class="chat-container">
        <!-- 채팅 메시지 영역 -->
        <div class="chat-messages" id="chatMessages">
            <!-- 초기 환영 메시지는 JavaScript에서 추가됩니다 -->
        </div>

        <!-- 하단 입력 영역 -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="답변을 입력하세요..."
                    rows="1"
                ></textarea>
                <div class="input-actions">
                    <button id="imageButton" class="input-button" title="이미지 업로드">📷</button>
                    <button id="sendButton" class="input-button primary" title="전송">📤</button>
                </div>
            </div>
            <input type="file" id="imageInput" class="file-input-hidden" accept="image/*">
        </div>
        
        <!-- 학습 마치기 버튼 -->
        <div class="finish-learning-container">
            <button id="finishLearningBtn" class="finish-learning-btn" disabled>
                🎯 학습 마치기
            </button>
        </div>
    </div>

    <!-- API 키 설정 모달 -->
    <div id="apiModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">🔑 OpenAI API 키 설정</h2>
            <div class="modal-description">
                Vision AI 이미지 분석을 위해 OpenAI API 키가 필요합니다.<br>
                <small>API 키는 브라우저에만 저장되며 외부로 전송되지 않습니다.</small>
            </div>
            <input type="password" id="apiKeyInput" class="modal-input" placeholder="sk-..." />
            <div id="apiError" class="error-message hidden"></div>
            <div class="modal-buttons">
                <button onclick="setApiKey()" class="modal-button primary">설정하기</button>
            </div>
        </div>
    </div>

    <script>
        // OpenAI 클라이언트 래퍼 클래스
        class OpenAIClient {
            constructor(apiKey) {
                this.apiKey = apiKey;
                this.baseURL = 'https://api.openai.com/v1';
            }

            async chat_completions_create(options) {
                const response = await fetch(`${this.baseURL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: options.model,
                        messages: options.messages,
                        max_tokens: options.max_tokens,
                        temperature: options.temperature
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 호출 실패: ${response.status}`);
                }

                return await response.json();
            }
        }

        // 전역 변수
        let apiKey = '';
        let openai = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userConcept = '';
        let isOCRProcessing = false;
        let currentPhase = 'setup'; // 'setup', 'concept', 'quiz', 'complete'
        let waitingForAnswer = false;
        let isProcessingMessage = false; // 메시지 처리 중복 방지
        let isComposing = false; // 한글 입력기(IME) 조합 중 여부
        let additionalQuestionCount = 0; // 추가 질문 카운트
        let maxAdditionalQuestions = 5; // 최대 추가 질문 수
        let hasImageUploaded = false; // 사진 업로드 여부

        // DOM 요소들
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const imageButton = document.getElementById('imageButton');
        const imageInput = document.getElementById('imageInput');
        const apiModal = document.getElementById('apiModal');
        const questionCounter = document.getElementById('questionCounter');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const finishLearningBtn = document.getElementById('finishLearningBtn');

        // 현재 시간 문자열 반환
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours < 12 ? '오전' : '오후';
            const displayHours = hours % 12 || 12;
            return `${ampm} ${displayHours}:${minutes.toString().padStart(2, '0')}`;
        }

        // 메시지 추가 함수
        function addMessage(content, isUser = false, isSystem = false) {
            const messageDiv = document.createElement('div');
            
            if (isSystem) {
                messageDiv.className = 'system-message';
                messageDiv.innerHTML = `<div class="message-bubble">${content}</div>`;
            } else {
                messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
                const avatar = isUser ? '👤' : '<img src="ai-tutor-profile.png" alt="콴다 AI 복습 코치" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; flex-shrink: 0;">'; 
                const timeText = getCurrentTime();
                messageDiv.innerHTML = `
                    <div class="avatar" style="width: 32px; height: 32px; background: ${isUser ? '#60a5fa' : '#4f46e5'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600; margin-right: 8px; align-self: flex-start; overflow: hidden; flex-shrink: 0; min-width: 32px; min-height: 32px; max-width: 32px; max-height: 32px;">${avatar}</div>
                    <div class="message-bubble" style="background: ${isUser ? '#3b82f6' : '#e5e7eb'}; color: ${isUser ? 'white' : '#374151'}; border-radius: 18px; border-bottom-${isUser ? 'right' : 'left'}-radius: 8px; padding: 12px 16px 32px 16px; position: relative; word-wrap: break-word; line-height: 1.4; max-width: 70%; align-self: ${isUser ? 'flex-end' : 'flex-start'}; margin-${isUser ? 'right' : 'left'}: 0; margin-${isUser ? 'left' : 'right'}: auto;">
                        ${content}
                        <div class="message-time" style="position: absolute; bottom: 4px; right: 8px; font-size: 10px; color: ${isUser ? 'rgba(255, 255, 255, 0.8)' : '#9ca3af'}; text-align: right;">${timeText}</div>
                    </div>
                `;
                
                // JavaScript로 추가 스타일 강제 적용
                setTimeout(() => {
                    const avatarEl = messageDiv.querySelector('.avatar');
                    const bubbleEl = messageDiv.querySelector('.message-bubble');
                    const timeEl = messageDiv.querySelector('.message-time');
                    
                    if (avatarEl) {
                        avatarEl.style.setProperty('width', '32px', 'important');
                        avatarEl.style.setProperty('height', '32px', 'important');
                        avatarEl.style.setProperty('border-radius', '50%', 'important');
                        avatarEl.style.setProperty('flex-shrink', '0', 'important');
                    }
                    
                    if (bubbleEl) {
                        bubbleEl.style.setProperty('max-width', '70%', 'important');
                        bubbleEl.style.setProperty('align-self', isUser ? 'flex-end' : 'flex-start', 'important');
                    }
                    
                    if (timeEl) {
                        timeEl.style.setProperty('position', 'absolute', 'important');
                        timeEl.style.setProperty('bottom', '4px', 'important');
                        timeEl.style.setProperty('right', '8px', 'important');
                    }
                }, 10);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // MathJax 렌더링 트리거
            if (window.MathJax) {
                MathJax.typesetPromise([messageDiv]).catch((err) => console.log('MathJax error:', err));
            }
            
            return messageDiv;
        }

        // 타이핑 인디케이터 추가
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai typing-indicator';
            typingDiv.innerHTML = `
                <div class="avatar" style="width: 32px; height: 32px; background: #4f46e5; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: 600; margin-right: 8px; align-self: flex-start; overflow: hidden; flex-shrink: 0; min-width: 32px; min-height: 32px; max-width: 32px; max-height: 32px;"><img src="ai-tutor-profile.png" alt="콴다 AI 복습 코치" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; flex-shrink: 0;"></div>
                <div class="message-bubble" style="background: #e5e7eb; color: #374151; border-radius: 18px; border-bottom-left-radius: 8px; padding: 12px 16px; position: relative; word-wrap: break-word; line-height: 1.4; max-width: 90%; align-self: flex-start; margin-left: 0; margin-right: auto;">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingDiv;
        }

        // 타이핑 인디케이터 제거
        function removeTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 추가 질문 카운터 업데이트
        function updateQuestionCounter() {
            questionCounter.textContent = `추가 질문 제한 (${additionalQuestionCount}/${maxAdditionalQuestions})`;
        }

        // 다음 질문 버튼 상태 업데이트
        function updateNextQuestionButton() {
            if (currentPhase === 'quiz' && !waitingForAnswer && currentQuestionIndex < questions.length - 1) {
                nextQuestionBtn.disabled = false;
            } else {
                nextQuestionBtn.disabled = true;
            }
        }

        // 학습 마치기 버튼 상태 업데이트
        function updateFinishLearningButton() {
            // 완료 단계일 때만 활성화
            if (currentPhase === 'complete') {
                finishLearningBtn.disabled = false;
            } else {
                finishLearningBtn.disabled = true;
            }
        }

        // API 키 설정
        function setApiKey() {
            console.log('setApiKey function called');
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            const errorDiv = document.getElementById('apiError');
            
            if (!key) {
                errorDiv.textContent = 'API 키를 입력해주세요!';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!key.startsWith('sk-')) {
                errorDiv.textContent = 'OpenAI API 키가 올바르지 않습니다. sk-로 시작해야 합니다.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            apiKey = key;
            openai = new OpenAIClient(key);
            localStorage.setItem('openai_api_key', key);
            
            // 모달 닫기
            apiModal.style.display = 'none';
            
            // 환영 메시지 추가
            addWelcomeMessages();
        }

        // 환영 메시지 추가
        function addWelcomeMessages() {
            setTimeout(() => {
                addMessage('안녕하세요! 👋 콴다 AI 복습 코치입니다.');
            }, 500);
            
            setTimeout(() => {
                addMessage('교과서나 노트 사진을 올려주세요. 사진을 분석하여 응용/변형 질문들을 만들어드리겠습니다! 📚✨');
            }, 1500);
            
            currentPhase = 'setup';
        }

        // 메시지 전송
        async function sendMessage() {
            // 중복 실행 방지
            if (isProcessingMessage || isComposing) return;
            
            const message = chatInput.value.trim();
            if (!message || isOCRProcessing) return;
            
            // 사진이 업로드되지 않은 경우 텍스트 입력 차단
            if (!hasImageUploaded) {
                addMessage('먼저 사진을 업로드해주세요! 📷', false);
                chatInput.value = '';
                adjustTextareaHeight();
                return;
            }
            
            // 불완전한 한글 자모음만 필터링 (완성된 글자나 숫자, 영문은 허용)
            if (message.length === 1 && /^[ㄱ-ㅎㅏ-ㅣ]$/.test(message)) {
                chatInput.value = '';
                adjustTextareaHeight();  
                return;
            }
            
            // 처리 중 플래그 설정
            isProcessingMessage = true;
            
            // UI 상태 업데이트 (처리 중)
            sendButton.disabled = true;
            chatInput.disabled = true;
            
            try {
                // 사용자 메시지 추가
                addMessage(message, true);
                
                // 입력창을 즉시 초기화
                chatInput.value = '';
                adjustTextareaHeight();
                
                // 현재 단계에 따른 처리 (퀴즈 단계만 허용)
                if (currentPhase === 'quiz') {
                    // 퀴즈 진행 중에는 항상 답변 처리 (첫 번째 답변이든 추가 질문이든)
                    await handleAnswerInput(message);
                } else {
                    addMessage('사진을 먼저 업로드해주세요! 📷', false);
                }
            } catch (error) {
                console.error('Message processing error:', error);
                addMessage('메시지 처리 중 오류가 발생했습니다. 다시 시도해주세요. 😅');
            } finally {
                // 처리 완료 후 플래그 해제 및 UI 상태 복원
                isProcessingMessage = false;
                sendButton.disabled = false;
                chatInput.disabled = false;
                chatInput.focus(); // 입력창에 다시 포커스
            }
        }

        // 개념 입력 처리 (사진 분석 결과를 퀴즈로 진행)
        async function handleConceptInput(concept) {
            userConcept = concept;
            currentPhase = 'quiz';
            
            const typing = addTypingIndicator();
            
            try {
                // GPT API로 질문 생성
                questions = await generateQuestions(concept);
                
                removeTypingIndicator();
                
                if (questions.length === 0) {
                    throw new Error('질문 생성에 실패했습니다.');
                }
                
                addMessage('좋습니다! 사진을 분석하여 응용/변형 질문들을 만들었습니다. 차근차근 같이 풀어보시죠! 🎯');
                
                // 첫 번째 질문 시작
                currentQuestionIndex = 0;
                additionalQuestionCount = 0; // 새로운 퀴즈 시작 시 카운터 리셋
                updateQuestionCounter();
                setTimeout(() => {
                    displayQuestion();
                }, 1000);
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Error starting quiz:', error);
                addMessage('질문을 만드는 중에 문제가 생겼습니다. 다시 시도해주시거나 API 키를 확인해주세요. 😅');
                currentPhase = 'concept';
            }
        }

        // 질문 구분선 추가
        function addQuestionDivider() {
            const questionNumber = currentQuestionIndex + 1;
            const dividerDiv = document.createElement('div');
            dividerDiv.className = 'question-divider';
            dividerDiv.innerHTML = `<div class="question-divider-text">질문 ${questionNumber}</div>`;
            chatMessages.appendChild(dividerDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 질문 표시
        function displayQuestion() {
            setTimeout(() => {
                // 모든 질문에 구분선 추가
                addQuestionDivider();
                
                addMessage(questions[currentQuestionIndex]);
                waitingForAnswer = true;
                // additionalQuestionCount는 누적되므로 리셋하지 않음
                updateQuestionCounter();
                updateNextQuestionButton();
                updateFinishLearningButton();
            }, 500);
        }

        // 답변 입력 처리
        async function handleAnswerInput(answer) {
            const typing = addTypingIndicator();
            
            try {
                // '다음' 입력 체크 (다양한 표현 포함)
                const nextKeywords = ['다음', '다음 문제', '다음 질문', '다음으로', '넘어가', '다음 문제로', '다음 질문으로'];
                const isNextRequest = nextKeywords.some(keyword => 
                    answer.trim().toLowerCase().includes(keyword)
                );
                
                if (isNextRequest) {
                    removeTypingIndicator();
                    
                    if (currentQuestionIndex === questions.length - 1) {
                        // 마지막 질문 완료
                        finishQuiz();
                    } else {
                        // 다음 질문으로 이동
                        currentQuestionIndex++;
                        displayQuestion();
                    }
                    return;
                }
                
                // 일반 답변이나 추가 질문 처리
                if (waitingForAnswer) {
                    // 첫 번째 답변: 피드백 제공
                    const feedback = await generateFeedback(questions[currentQuestionIndex], answer);
                    removeTypingIndicator();
                    
                    // 마지막 질문인 경우 채팅 종료
                    if (currentQuestionIndex === questions.length - 1) {
                        addMessage(feedback);
                        setTimeout(() => {
                            addMessage('채팅이 종료되었습니다.', false, true); // 시스템 메시지로 표시
                        }, 1000);
                        
                        // 채팅 입력 비활성화
                        chatInput.disabled = true;
                        sendButton.disabled = true;
                        imageButton.disabled = true;
                        nextQuestionBtn.disabled = true;
                        
                        // 학습 마치기 버튼 활성화
                        finishLearningBtn.disabled = false;
                        
                        currentPhase = 'complete';
                    } else {
                        // 마지막 질문이 아닌 경우 계속 진행
                        let nextInstruction = "\n\n더 궁금한 점이 있으시면 언제든 물어보세요.";
                        addMessage(feedback + nextInstruction);
                        waitingForAnswer = false; // 이제 추가 질문도 받을 수 있음
                        updateNextQuestionButton();
                        updateFinishLearningButton();
                    }
                } else {
                    // 추가 질문 제한 확인
                    if (additionalQuestionCount >= maxAdditionalQuestions) {
                        removeTypingIndicator();
                        addMessage('추가 질문 제한에 도달했습니다. 다음 질문으로 넘어가시거나 다른 질문을 해보세요! 😊');
                        return;
                    }
                    
                    // 추가 질문: 해당 질문에 대한 답변 제공
                    const followUpAnswer = await generateFollowUpAnswer(questions[currentQuestionIndex], answer);
                    removeTypingIndicator();
                    addMessage(followUpAnswer + "\n\n더 궁금한 점이 있으시면 언제든 물어보세요.");
                    
                    // 추가 질문 카운터 증가
                    additionalQuestionCount++;
                    updateQuestionCounter();
                }
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Error processing answer:', error);
                addMessage('답변을 처리하는 중에 문제가 생겼습니다. 다시 시도해주세요. 😅');
            }
        }

        // 다음 질문으로 이동
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            } else {
                finishQuiz();
            }
        }

        // 추가 질문에 대한 답변 생성
        async function generateFollowUpAnswer(originalQuestion, followUpQuestion) {
            const prompt = `[역할]
너는 수학 과외 선생님이자 AI 튜터야. 학생의 추가 질문에 대해 명확하고 이해하기 쉬운 답변을 제공해야 해.

[조건]
- 학생의 질문 의도를 정확히 파악하고 답변하기
- 복잡한 개념도 쉽게 설명하기
- 구체적인 예시나 수치를 활용하여 설명하기
- 부드럽고 친절한 톤 유지하기

**원래 질문:** ${originalQuestion}
**학생의 추가 질문:** ${followUpQuestion}

[예시 답변]
학생: "왜 극한값이 존재하지 않을 수 있나요?"
AI:
> 좋은 질문이네요! 극한값이 존재하지 않는 경우를 생각해보면, 함수가 그 점에서 '점프'를 하거나 '구멍'이 있을 때예요. 예를 들어, f(x) = |x|/x 함수에서 x=0 근처를 보면, 왼쪽에서 접근할 때는 -1, 오른쪽에서 접근할 때는 1이 되죠. 이렇게 양쪽에서 접근하는 값이 다르면 극한값이 존재하지 않아요.

위 예시처럼 학생의 추가 질문에 대해 명확하고 이해하기 쉬운 답변을 제공해주세요.`;

            try {
                const response = await openai.chat_completions_create({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 800,
                    temperature: 0.7
                });

                return response.choices[0].message.content;
                
            } catch (error) {
                console.error('GPT API Error:', error);
                throw error;
            }
        }

        // 퀴즈 완료 (다음 질문 버튼으로 마지막 질문 완료 시)
        function finishQuiz() {
            currentPhase = 'complete';
            
            setTimeout(() => {
                addMessage('채팅이 종료되었습니다.', false, true); // 시스템 메시지로 표시
            }, 500);
            
            // 채팅 입력 비활성화
            chatInput.disabled = true;
            sendButton.disabled = true;
            imageButton.disabled = true;
            nextQuestionBtn.disabled = true;
            
            // 학습 마치기 버튼 활성화
            finishLearningBtn.disabled = false;
        }

        // 이미지 업로드 처리
        function handleImageUpload(file) {
            if (!file || !file.type.startsWith('image/')) {
                addMessage('이미지 파일만 올릴 수 있습니다! 📷', false);
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                addMessage('파일이 너무 커요. 10MB 이하로 올려주세요. 📁', false);
                return;
            }

            // 이미지 미리보기 추가
            const reader = new FileReader();
            reader.onload = function(e) {
                const imagePreview = `<div class="image-preview-message"><img src="${e.target.result}" alt="업로드된 이미지"></div>`;
                
                // 최초 업로드인지 확인
                if (!hasImageUploaded) {
                    // 최초 업로드: 수학 문제 분석
                    addMessage(imagePreview + '사진을 올려주셨네요! AI가 이미지를 분석해보겠습니다...', true);
                    hasImageUploaded = true; // 사진 업로드 완료 표시
                    
                    // API 키가 있으면 Vision API로 분석
                    if (apiKey) {
                        analyzeImageConcept(file);
                    } else {
                        addMessage('AI 이미지 분석을 위해 먼저 API 키를 설정해주세요! 🔑');
                        performOCR(file);
                    }
                } else {
                    // 이후 업로드: 학생 풀이 분석
                    addMessage(imagePreview + '풀이 사진을 올려주셨네요! AI가 풀이를 분석해보겠습니다...', true);
                    
                    // 학생 풀이 분석
                    analyzeStudentSolution(file);
                }
            };
            reader.readAsDataURL(file);
        }

        // Vision API로 이미지 개념 분석
        async function analyzeImageConcept(file) {
            if (isOCRProcessing) return;
            
            isOCRProcessing = true;
            const typing = addTypingIndicator();
            
            try {
                const base64Image = await fileToBase64(file);
                
                const response = await openai.chat_completions_create({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: `이 이미지가 수학 문제인지 판단하고, 수학 문제라면 분석해주세요:

**1단계: 수학 문제 판단**
먼저 이 이미지가 수학 문제인지 판단해주세요.
- 수학 문제: 숫자, 수식, 도형, 수학적 개념이 포함된 문제
- 수학 문제가 아님: 일상적인 이미지, 다른 과목 문제, 의미 없는 이미지 등

**2단계: 수학 문제인 경우 분석**
수학 문제로 판단되면 다음 형식으로 분석해주세요:

문제 조건: [주어진 모든 조건과 수치]
구하는 것: [구하고자 하는 답]
핵심 개념: [사용되는 주요 수학 개념]
해결 방법: [문제 해결의 핵심 접근법]

**출력 형식:**
수학 문제 여부: [예/아니오]
[수학 문제인 경우에만 아래 내용 포함]
문제 조건: [내용]
구하는 것: [내용]
핵심 개념: [내용]
해결 방법: [내용]

위 형식으로 판단하고 분석해주세요.`
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 800
                });

                const analysisResult = response.choices[0].message.content.trim();
                
                removeTypingIndicator();
                
                // 수학 문제 여부 판단
                const isMathProblemMatch = analysisResult.match(/수학 문제 여부:\s*(예|아니오)/);
                const isMathProblem = isMathProblemMatch && isMathProblemMatch[1] === '예';
                
                if (!isMathProblem) {
                    // 수학 문제가 아닌 경우
                    addMessage('❌ 이 이미지는 수학 문제가 아니거나 제대로 인식되지 않았습니다. 📷');
                    addMessage('수학 문제 사진을 다시 올려주세요! 🧮');
                    
                    // 이미지 업로드 상태 초기화
                    hasImageUploaded = false;
                    
                    // 이미지 미리보기 제거
                    const imagePreviewMessages = document.querySelectorAll('.image-preview-message');
                    imagePreviewMessages.forEach(msg => msg.remove());
                    
                    return;
                }
                
                // 분석 결과를 파싱하여 핵심 정보 추출
                const conditionMatch = analysisResult.match(/문제 조건:\s*(.+)/);
                const targetMatch = analysisResult.match(/구하는 것:\s*(.+)/);
                const conceptMatch = analysisResult.match(/핵심 개념:\s*(.+)/);
                const methodMatch = analysisResult.match(/해결 방법:\s*(.+)/);
                
                const condition = conditionMatch ? conditionMatch[1].trim() : '주어진 조건들';
                const target = targetMatch ? targetMatch[1].trim() : '구하고자 하는 답';
                const concept = conceptMatch ? conceptMatch[1].trim() : '수학 개념';
                const method = methodMatch ? methodMatch[1].trim() : '';
                
                // 분석 결과 표시
                addMessage(`✅ ${concept} 문제를 분석했습니다.`);
                
                if (condition) {
                    setTimeout(() => {
                        addMessage(`📋 문제 조건: ${condition}`);
                    }, 1000);
                }
                
                if (target) {
                    setTimeout(() => {
                        addMessage(`🎯 구하는 것: ${target}`);
                    }, 2000);
                }
                
                if (method) {
                    setTimeout(() => {
                        addMessage(`💡 해결 방법: ${method}`);
                    }, 3000);
                }
                
                // 자동으로 응용 질문 생성 시작
                setTimeout(() => {
                    addMessage('이제 이 문제를 바탕으로 응용/변형 질문들을 만들어보겠습니다! 🎯');
                    handleConceptInput(analysisResult);
                }, 4500);
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Vision Analysis Error:', error);
                addMessage('❌ AI 분석이 실패했습니다. 다른 방법으로 시도해보겠습니다! 🔄');
                
                // 실패 시 OCR로 대체
                setTimeout(() => {
                    performOCR(file);
                }, 1000);
            }
            
            isOCRProcessing = false;
        }

        // OCR 텍스트 인식
        async function performOCR(file) {
            if (isOCRProcessing) return;
            
            isOCRProcessing = true;
            const typing = addTypingIndicator();
            
            try {
                removeTypingIndicator();
                addMessage('텍스트를 읽고 있습니다... 📖');
                const newTyping = addTypingIndicator();
                
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'kor+eng',
                    {
                        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz가-힣+-*/=()[]{}^√∞∑∫≤≥≠→←↑↓°′″αβγδεζηθικλμνξοπρστυφχψω∀∃∈∉⊂⊃∪∩∅ℝℂℕℤℚ∴∵∝∼≅≡∝∠⊥∥⟂△▲▼▶◀●○■□★☆',
                        preserve_interword_spaces: '1',
                        tessedit_do_invert: '0',
                        textord_heavy_nr: '1',
                        textord_min_linesize: '2.5'
                    }
                );
                
                // 수학 기호 후처리
                let cleanedText = text
                    .replace(/"/g, '²')
                    .replace(/'/g, '′')
                    .replace(/—/g, '-')
                    .replace(/–/g, '-')
                    .replace(/\|/g, '1')
                    .replace(/O/g, '0')
                    .replace(/l/g, '1')
                    .replace(/\s*x\s*/g, '×')
                    .replace(/\s*\*\s*/g, '×')
                    .replace(/\/\s*/g, '÷')
                    .replace(/<=|≤/g, '≤')
                    .replace(/>=|≥/g, '≥')
                    .replace(/!=/g, '≠')
                    .replace(/\s+/g, ' ')
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .join('\n');
                
                removeTypingIndicator();
                
                if (cleanedText.trim()) {
                    addMessage(`📝 텍스트 인식 완료!\n\n${cleanedText}`);
                    
                    // OCR 결과를 GPT로 분석하여 문제의 의도와 개념 파싱
                    setTimeout(() => {
                        analyzeOCRResult(cleanedText);
                    }, 1000);
                } else {
                    addMessage('❌ 이미지에서 수학 문제를 인식할 수 없습니다. 📷');
                    addMessage('더 선명한 수학 문제 사진을 다시 올려주세요! 🧮');
                    
                    // 이미지 업로드 상태 초기화
                    hasImageUploaded = false;
                    
                    // 이미지 미리보기 제거
                    const imagePreviewMessages = document.querySelectorAll('.image-preview-message');
                    imagePreviewMessages.forEach(msg => msg.remove());
                    
                    throw new Error('텍스트를 인식할 수 없습니다.');
                }
                
            } catch (error) {
                removeTypingIndicator();
                console.error('OCR Error:', error);
                addMessage('❌ 이미지에서 수학 문제를 인식할 수 없습니다. 📷');
                addMessage('더 선명한 수학 문제 사진을 다시 올려주세요! 🧮');
                
                // 이미지 업로드 상태 초기화
                hasImageUploaded = false;
                
                // 이미지 미리보기 제거
                const imagePreviewMessages = document.querySelectorAll('.image-preview-message');
                imagePreviewMessages.forEach(msg => msg.remove());
            }
            
            isOCRProcessing = false;
        }

        // 학생 풀이 분석 (OCR + GPT 분석)
        async function analyzeStudentSolution(file) {
            if (isOCRProcessing) return;
            
            isOCRProcessing = true;
            const typing = addTypingIndicator();
            
            try {
                removeTypingIndicator();
                addMessage('풀이를 읽고 있습니다... 📖');
                const newTyping = addTypingIndicator();
                
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'kor+eng',
                    {
                        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz가-힣+-*/=()[]{}^√∞∑∫≤≥≠→←↑↓°′″αβγδεζηθικλμνξοπρστυφχψω∀∃∈∉⊂⊃∪∩∅ℝℂℕℤℚ∴∵∝∼≅≡∝∠⊥∥⟂△▲▼▶◀●○■□★☆',
                        preserve_interword_spaces: '1',
                        tessedit_do_invert: '0',
                        textord_heavy_nr: '1',
                        textord_min_linesize: '2.5'
                    }
                );
                
                // 수학 기호 후처리
                let cleanedText = text
                    .replace(/"/g, '²')
                    .replace(/'/g, '′')
                    .replace(/—/g, '-')
                    .replace(/–/g, '-')
                    .replace(/\|/g, '1')
                    .replace(/O/g, '0')
                    .replace(/l/g, '1')
                    .replace(/\s*x\s*/g, '×')
                    .replace(/\s*\*\s*/g, '×')
                    .replace(/\/\s*/g, '÷')
                    .replace(/<=|≤/g, '≤')
                    .replace(/>=|≥/g, '≥')
                    .replace(/!=/g, '≠')
                    .replace(/\s+/g, ' ')
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .join('\n');
                
                removeTypingIndicator();
                
                if (cleanedText.trim()) {
                    addMessage(`📝 풀이 인식 완료!\n\n${cleanedText}`);
                    
                    // OCR 결과를 GPT로 분석하여 풀이 피드백 생성
                    setTimeout(() => {
                        analyzeStudentSolutionResult(cleanedText);
                    }, 1000);
                } else {
                    addMessage('❌ 풀이를 인식할 수 없습니다. 📷');
                    addMessage('더 선명한 풀이 사진을 다시 올려주세요! ✍️');
                    
                    // 이미지 미리보기 제거
                    const imagePreviewMessages = document.querySelectorAll('.image-preview-message');
                    imagePreviewMessages.forEach(msg => msg.remove());
                }
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Student Solution OCR Error:', error);
                addMessage('❌ 풀이를 인식할 수 없습니다. 📷');
                addMessage('더 선명한 풀이 사진을 다시 올려주세요! ✍️');
                
                // 이미지 미리보기 제거
                const imagePreviewMessages = document.querySelectorAll('.image-preview-message');
                imagePreviewMessages.forEach(msg => msg.remove());
            }
            
            isOCRProcessing = false;
        }

        // OCR 결과를 GPT로 분석하여 문제의 의도와 개념 파싱
        async function analyzeOCRResult(ocrText) {
            const typing = addTypingIndicator();
            
            try {
                const response = await openai.chat_completions_create({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: `다음 텍스트가 수학 문제인지 판단하고, 수학 문제라면 분석해주세요:

**OCR로 인식된 텍스트:**
${ocrText}

**1단계: 수학 문제 판단**
먼저 이 텍스트가 수학 문제인지 판단해주세요.
- 수학 문제: 숫자, 수식, 도형, 수학적 개념이 포함된 문제
- 수학 문제가 아님: 일상적인 텍스트, 다른 과목 문제, 의미 없는 텍스트 등

**2단계: 수학 문제인 경우 분석**
수학 문제로 판단되면 다음 형식으로 분석해주세요:

문제 조건: [주어진 모든 조건과 수치 - 구체적인 도형, 각도, 길이 포함]
구하는 것: [구하고자 하는 답 - 정확한 형태와 단위]
핵심 개념: [사용되는 주요 수학 개념 - 구체적인 개념명]
해결 방법: [문제 해결의 핵심 접근법 - 단계별 논리적 과정]
도형/그래프 정보: [문제에서 사용된 도형, 그래프, 좌표계 등의 구체적 정보]

**출력 형식:**
수학 문제 여부: [예/아니오]
[수학 문제인 경우에만 아래 내용 포함]
문제 조건: [내용]
구하는 것: [내용]
핵심 개념: [내용]
해결 방법: [내용]
도형/그래프 정보: [내용]

**분석 기준:**
- 원문 문제의 문맥(도형, 수치, 조건)을 벗어나지 않는 분석
- 구체적인 수치와 도형 정보를 정확히 파악
- 수학적으로 정확한 표현과 개념 사용
- 학생이 논리적으로 답을 유도할 수 있는 구조 파악

위 형식으로 판단하고 분석해주세요.`
                        }
                    ],
                    max_tokens: 800
                });

                const analysisResult = response.choices[0].message.content.trim();
                
                removeTypingIndicator();
                
                // 수학 문제 여부 확인
                const isMathProblemMatch = analysisResult.match(/수학 문제 여부:\s*(.+)/);
                const isMathProblem = isMathProblemMatch && isMathProblemMatch[1].trim() === '예';
                
                if (!isMathProblem) {
                    addMessage('❌ 업로드된 사진이 수학 문제가 아니거나 제대로 인식되지 않았습니다. 수학 문제 사진을 다시 업로드해주세요! 📚');
                    hasImageUploaded = false; // 사진 업로드 상태 리셋
                    return;
                }
                
                // 분석 결과를 파싱하여 핵심 정보 추출
                const conditionMatch = analysisResult.match(/문제 조건:\s*(.+)/);
                const targetMatch = analysisResult.match(/구하는 것:\s*(.+)/);
                const conceptMatch = analysisResult.match(/핵심 개념:\s*(.+)/);
                const methodMatch = analysisResult.match(/해결 방법:\s*(.+)/);
                const diagramMatch = analysisResult.match(/도형\/그래프 정보:\s*(.+)/);
                
                const condition = conditionMatch ? conditionMatch[1].trim() : '주어진 조건들';
                const target = targetMatch ? targetMatch[1].trim() : '구하고자 하는 답';
                const concept = conceptMatch ? conceptMatch[1].trim() : '수학 개념';
                const method = methodMatch ? methodMatch[1].trim() : '';
                const diagram = diagramMatch ? diagramMatch[1].trim() : '';
                
                // 분석 결과 표시
                addMessage(`✅ ${concept} 문제를 분석했습니다.`);
                
                if (condition) {
                    setTimeout(() => {
                        addMessage(`📋 문제 조건: ${condition}`);
                    }, 1000);
                }
                
                if (target) {
                    setTimeout(() => {
                        addMessage(`🎯 구하는 것: ${target}`);
                    }, 2000);
                }
                
                if (diagram) {
                    setTimeout(() => {
                        addMessage(`📐 도형/그래프 정보: ${diagram}`);
                    }, 3000);
                }
                
                if (method) {
                    setTimeout(() => {
                        addMessage(`💡 해결 방법: ${method}`);
                    }, 4000);
                }
                
                // 자동으로 응용 질문 생성 시작
                setTimeout(() => {
                    addMessage('이제 이 문제를 바탕으로 응용/변형 질문들을 만들어보겠습니다! 🎯');
                    handleConceptInput(analysisResult);
                }, 5500);
                
            } catch (error) {
                removeTypingIndicator();
                console.error('OCR Analysis Error:', error);
                addMessage('문제 분석 중 오류가 발생했습니다. 다시 시도해주세요. 😅');
                
                // 분석 실패 시 원본 텍스트로 진행
                setTimeout(() => {
                    handleConceptInput(ocrText);
                }, 1000);
            }
        }

        // 학생 풀이 결과 분석 및 피드백 생성
        async function analyzeStudentSolutionResult(solutionText) {
            const typing = addTypingIndicator();
            
            try {
                const response = await openai.chat_completions_create({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: `학생의 수학 문제 풀이를 분석하고 피드백을 제공해주세요.

**학생 풀이:**
${solutionText}

**분석 요청사항:**
1. 풀이의 정확성 판단 (정답/부분 정답/오답)
2. 풀이 과정의 논리적 타당성
3. 사용된 수학 개념의 정확성
4. 계산 과정의 정확성
5. 개선이 필요한 부분

**피드백 형식:**
학생: [학생의 풀이 내용]

AI: [피드백 내용 - 정답인 경우 "좋은 풀이에요!"로 시작, 오답인 경우 "좋은 시도지만, 제가 더 보충해드릴게요!"로 시작]

**피드백 원칙:**
- 정답인 경우: 칭찬과 함께 핵심 개념과 논리 설명
- 오답인 경우: 어떤 개념이 혼동되었는지, 어떤 조건이 빠졌는지 명확히 설명
- 친근하고 정확한 톤 사용
- 수학적으로 정확한 표현 사용

위 형식으로 분석하고 피드백을 제공해주세요.`
                        }
                    ],
                    max_tokens: 800
                });

                const feedbackResult = response.choices[0].message.content.trim();
                
                removeTypingIndicator();
                
                // 피드백 결과 표시
                addMessage(feedbackResult);
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Student Solution Analysis Error:', error);
                addMessage('풀이 분석 중 오류가 발생했습니다. 다시 시도해주세요. 😅');
            }
        }

        // GPT API로 질문 생성
        async function generateQuestions(concept) {
            const prompt = `[역할]
너는 수학 문제를 개념적으로 분석하고, 학생의 깊은 사고를 유도하는 튜터야. 

[목표]
너는 주어진 수학 문제에 대해:
1. 핵심 개념을 기반으로
2. 학생이 놓치기 쉬운 조건, 혼동하기 쉬운 상황을 바탕으로
3. '문제 내 도형/수치/상황'을 적극 활용하여

다음 세 가지 유형의 응용 질문을 5~8개 생성해야 해:
- 조건을 조금만 바꿔도 정답이 달라지는 문제 (조건 조작)
- 학생이 흔히 하는 오개념이나 실수를 유도하는 문제 (오개념 탐색)
- 문제에서 도출한 결론을 역으로 추론하게 하는 문제 (역추론) - 이 유형을 더 많이 포함

[절대 금지사항]
- "어떤 성질", "어떤 각", "어떤 조건" 등의 추상적 표현
- 실생활 소재(피자, 지우개, 공, 책상 등)를 사용한 비유나 예시
- "어떻게 생각하나요?", "왜 그럴까요?" 등의 일반 논술형 질문
- 원문 문제의 문맥(도형, 수치, 조건)을 벗어난 질문
- 원문 문제와 무관한 확장 개념 도입
- 실생활 문제나 일상 비유 사용 금지
- "기울기와 길이의 관계는?" 같은 모호하거나 개념 불일치한 질문

[제약 조건]
- 반드시 원문 문제의 도형, 수치, 기호, 관계를 기반으로 질문을 만드세요.
- "기울기와 길이의 관계는?" 같은 모호하거나 개념 불일치한 질문은 금지합니다.
- '피자', '일상', '상상' 등의 일상적 비유는 사용하지 마세요.
- "어떤 성질", "어떤 조건" 등 모호한 표현은 피하고 명확한 수학 용어만 사용하세요.
- 질문은 반드시 실제 수학 문제 풀이를 유도해야 하며, 정답 유도 과정이 명확해야 합니다.

[품질 평가 기준]
1. 문제의 맥락이 명확히 주어졌는가? (원문의 도형, 수치, 조건이 명확히 포함되어야 함)
2. 문제의 조건이나 수치를 활용한 사고 유도가 이루어졌는가? (구체적인 수치 계산이나 조건 분석이 가능해야 함)
3. 개념 간의 연결이 적절한가? (기울기 vs 길이처럼 무관한 개념 연결 금지)
4. 정답 유도 또는 오답 분석이 가능한 구조인가? (학생이 논리적으로 답을 도출할 수 있어야 함)
5. 수학적으로 정확한 표현과 개념을 사용하고 있는가? (수학 용어와 기호의 정확한 사용)

[지향사항]
- 원문 문제의 수치와 조건을 반드시 포함하여 구성 (각도, 길이, 계수, 확률, 항, 극한값, 적분값 등)
- 학생이 논리적으로 정답을 유도할 수 있도록 설계
- 핵심 개념에 대한 혼동/변형/적용을 중심으로 질문 구성
- 구체적인 수치를 명시하여 추상성 제거
- 문제의 문맥을 벗어나지 않는 질문 구성:
  - 공통수학: 실수, 다항식, 이차함수, 삼각형, 확률의 기본 개념
  - 대수: 집합, 명제, 방정식, 수열, 극한의 기본 개념
  - 미적분: 극한, 도함수, 적분, 지수함수, 로그함수의 기본 개념
  - 확률과 통계: 순열조합, 확률분포, 통계적 추정의 기본 개념
  - 기하: 평면도형, 공간도형, 벡터, 이차곡선의 기본 개념
- 각 수학 영역의 교육과정 수준에 맞는 적절한 개념과 용어 사용

[질문 생성 원칙]
1. 원문 문제의 구체적인 수치와 조건을 반드시 활용 (각도, 길이, 계수, 확률, 항, 극한값 등)
2. 조건 변형 시 구체적인 수치로 변경 (예: 58° → 62°, f(x)=x² → f(x)=x³, 확률 1/3 → 1/4, 극한값 2 → 3)
3. 문제의 핵심 요소(도형, 함수, 수열, 확률, 극한, 적분 등)를 명확히 제시
4. 학생이 실제 계산이나 추론을 통해 답을 구할 수 있는 구조
5. 추상적인 표현 대신 구체적인 수학적 조건 사용
6. 3가지 유형을 포함하여 질문 생성 (역추론을 더 많이 포함):
   - 조건 조작: 구체적인 수치나 조건을 바꿔서 결과 변화 탐색
   - 오개념 탐색: 학생이 흔히 하는 실수나 잘못된 직관 유도
   - 역추론: 답이 다르다고 가정하고 조건 변화 추론 (이 유형을 더 많이 포함)
7. 문제의 수학 영역에 맞는 적절한 개념과 용어 사용:
   - 공통수학1/2: 실수, 다항식, 이차함수, 삼각형, 확률
   - 대수: 집합, 명제, 방정식, 수열, 극한
   - 미적분1/2: 극한, 도함수, 적분, 지수함수, 로그함수
   - 확률과 통계: 순열조합, 확률분포, 통계적 추정
   - 기하: 평면도형, 공간도형, 벡터, 이차곡선

**분석된 개념/문제:**
${concept}

[문제 예시]
[문제 본문 입력 위치]

[결과 형식 - 3가지 유형별 예시]

**1. 조건 조작:**
- ∠AOB가 30°가 아닌 45°라면 AB의 길이가 같을 때, 삼각형 OAB의 형태는 어떻게 달라질까요?
- f(x)=x²가 아닌 f(x)=x³일 때, 구간 [0,2]에서의 평균변화율은 어떻게 달라질까요?

**2. 오개념 탐색:**
- 학생이 "세 변의 길이가 같으면 합동이다"라고 생각한다면, 어떤 오류가 발생할 수 있을까요?
- "극한값이 존재하면 함수가 연속이다"라는 생각이 틀린 이유는 무엇일까요?

**3. 역추론 (더 많이 포함):**
- 답이 60°가 아니라 45°라면, 어떤 조건이 바뀌었을 가능성이 있을까요?
- 적분값이 8이 아니라 12라면, 어떤 조건이 달라졌을까요?
- 답이 2가 아니라 3이라면, 어떤 수치나 조건이 바뀌었을까요?
- 결과가 양수가 아니라 음수라면, 어떤 조건이 달라졌을까요?

위 형식처럼 주어진 문제의 문맥과 수치를 활용하여 5~8개의 응용 질문을 생성해주세요. 각 질문은 반드시 구체적인 수치나 조건을 포함하고, 학생이 실제로 계산하거나 추론할 수 있는 형태여야 합니다. 3가지 유형(조건 조작, 오개념 탐색, 역추론)을 포함하되, 역추론 유형을 더 많이 포함하여 질문을 생성하세요.

**중요**: 질문은 반드시 숫자(1., 2., 3.) 또는 기호(•, -)로 시작해야 하며, 제목이나 카테고리는 포함하지 마세요.`;

            try {
                const response = await openai.chat_completions_create({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 800,
                    temperature: 0.7
                });

                const content = response.choices[0].message.content;
                console.log('GPT Response:', content);
                
                // 질문 추출 (개선된 로직)
                const questions = [];
                const lines = content.split('\n');
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // 제목이나 카테고리 라인은 건너뛰기
                    if (line.includes('**') && line.includes(':')) {
                        continue;
                    }
                    
                    // 숫자로 시작하는 질문 (1., 2., 3. 등) 또는 •, - 로 시작하는 질문 추출
                    if (line.match(/^\d+\./) || line.startsWith('•') || line.startsWith('-')) {
                        const question = line.replace(/^\d+\.\s*/, '').replace(/^[•\-]\s*/, '').trim();
                        if (question.length > 0 && !question.includes('**')) {
                            questions.push(question);
                        }
                    }
                }
                
                console.log('Extracted questions:', questions);
                
                // 유효한 질문이 없으면 기본 질문 사용
                if (questions.length === 0) {
                    console.warn('No valid questions generated, using fallback questions');
                    return generateFallbackQuestions(concept);
                }
                
                return questions;
                
            } catch (error) {
                console.error('GPT API Error:', error);
                console.warn('Using fallback questions due to API error');
                return generateFallbackQuestions(concept);
            }
        }

        // 기본 질문 생성 (GPT API 실패 시 사용)
        function generateFallbackQuestions(concept) {
            const fallbackQuestions = [
                "이 문제의 핵심 조건 중 하나를 구체적인 수치로 바꾼다면, 답은 어떻게 달라질까요? (조건 조작)",
                "학생이 이 문제를 풀 때 자주 하는 실수나 오개념은 무엇일까요? (오개념 탐색)",
                "문제에서 구한 답이 다르다고 가정하면, 어떤 조건이 바뀌었을 가능성이 있을까요? (역추론)",
                "답이 양수가 아니라 음수라면, 어떤 조건이 달라졌을까요? (역추론)",
                "결과가 2가 아니라 3이라면, 어떤 수치나 조건이 바뀌었을까요? (역추론)",
                "학생이 이 문제를 풀 때 놓치기 쉬운 중요한 조건이나 개념은 무엇일까요? (오개념 탐색)",
                "만약 답이 예상과 다르다면, 어떤 조건이 바뀌었을 가능성이 있을까요? (역추론)",
                "이 문제의 조건을 바꿔서 다른 결과가 나오게 하려면 어떤 부분을 수정해야 할까요? (조건 조작)"
            ];
            
            return fallbackQuestions;
        }

        // GPT API로 피드백 생성
        async function generateFeedback(question, answer) {
            const prompt = `[역할]
너는 수학 과외 선생님이자 AI 튜터야. 학생의 응답이 정답인지 판단하고, 오답이라면 '어떤 개념을 혼동했는지'를 분석하여 설명하고, 다음에 어떻게 사고하면 좋을지를 제시해야 해.

[조건]
- 정답이면: 칭찬 + 핵심 근거 짚기
- 오답이면: 개념 혼동 설명 → 어떤 조건이 빠졌는지, 무엇과 무엇을 헷갈렸는지를 명확히 알려주기
- 내부 판단 로그는 감추고, 출력되는 메시지는 부드럽고 친절하지만 정확하게

**학생이 답한 질문:** ${question}
**학생 답변:** ${answer}

[예시 응답]
학생: "세 변의 길이가 같으면 합동이잖아요?"
AI:
> 정답과는 조금 다릅니다. 세 변의 길이가 같은 것만으로 합동이라고 단정 지을 수는 없어요. 합동 조건 중 SSS는 세 변이 각각 같을 때 성립하지만, 현재 문제는 각의 정보도 필요해요. 예를 들어 SAS는 두 변과 그 사이 각이 같을 때 합동이죠. 이 차이를 다시 확인해 보세요.

위 예시처럼 학생의 답변을 분석하고 적절한 피드백을 제공해주세요. 정답이면 칭찬하고 핵심 근거를 짚어주고, 오답이면 어떤 개념을 혼동했는지 명확히 설명해주세요.`;

            try {
                const response = await openai.chat_completions_create({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 800,
                    temperature: 0.7
                });

                return response.choices[0].message.content;
                
            } catch (error) {
                console.error('GPT API Error:', error);
                throw error;
            }
        }

        // 파일을 Base64로 변환
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // 텍스트 영역 높이 자동 조절
        function adjustTextareaHeight() {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + 'px';
        }

        // 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', function() {
            // 저장된 API 키 확인
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKeyInput').value = savedApiKey;
                apiKey = savedApiKey;
                openai = new OpenAIClient(savedApiKey);
                apiModal.style.display = 'none';
                addWelcomeMessages();
            }

            // 초기 상태 설정
            updateQuestionCounter();
            updateNextQuestionButton();
            updateFinishLearningButton();

            // 전송 버튼 클릭
            sendButton.addEventListener('click', function() {
                if (!isProcessingMessage) {
                    sendMessage();
                }
            });

            // 한글 입력기(IME) 이벤트 처리
            chatInput.addEventListener('compositionstart', function(e) {
                isComposing = true;
            });

            chatInput.addEventListener('compositionend', function(e) {
                isComposing = false;
                // composition 완료 후 자연스럽게 처리 (값 덮어쓰기 제거)
            });

            // 엔터 키 전송 (Shift+Enter는 줄바꿈)
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && !isProcessingMessage && !isComposing) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // 텍스트 영역 높이 자동 조절
            chatInput.addEventListener('input', adjustTextareaHeight);

            // 이미지 업로드 버튼
            imageButton.addEventListener('click', function() {
                imageInput.click();
            });

            // 이미지 선택 이벤트
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            });

            // API 키 입력에서 엔터 키
            document.getElementById('apiKeyInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    setApiKey();
                }
            });

            // 다음 질문 버튼 클릭 이벤트
            nextQuestionBtn.addEventListener('click', function() {
                console.log('Next question button clicked');
                console.log('Button disabled:', nextQuestionBtn.disabled);
                console.log('Current phase:', currentPhase);
                console.log('Waiting for answer:', waitingForAnswer);
                console.log('Current question index:', currentQuestionIndex);
                console.log('Total questions:', questions.length);
                
                if (!nextQuestionBtn.disabled) {
                    nextQuestion();
                } else {
                    console.log('Button is disabled, cannot proceed');
                }
            });

            // 학습 마치기 버튼 클릭 이벤트
            finishLearningBtn.addEventListener('click', function() {
                console.log('Finish learning button clicked');
                if (!finishLearningBtn.disabled) {
                    finishQuiz();
                } else {
                    console.log('Button is disabled, cannot proceed');
                }
            });
        });
    </script>
</body>
</html>