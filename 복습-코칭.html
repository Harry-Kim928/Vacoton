<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vision AI ë³µìŠµ ì½”ì¹­ - ì±„íŒ…í˜• í•™ìŠµ</title>
    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    
    <!-- Chart.js for mathematical visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- MathJax for LaTeX rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* í—¤ë” */
        .chat-header {
            background: #4f46e5;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .chat-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-left: 10px;
        }

        .tutor-profile {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            overflow: hidden;
        }
        
        .tutor-profile img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* ë§í’ì„  ê³µí†µ ìŠ¤íƒ€ì¼ */
        .message {
            display: flex;
            margin-bottom: 20px;
            animation: fadeInUp 0.3s ease-out;
        }

        .message.ai {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* AI íŠœí„° ë§í’ì„  (ì™¼ìª½, íšŒìƒ‰) */
        .message.ai .message-bubble {
            background: #e5e7eb;
            color: #374151;
            border-bottom-left-radius: 8px;
            margin-left: 50px;
        }

        .message.ai .avatar {
            width: 36px;
            height: 36px;
            background: #4f46e5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-right: 12px;
            align-self: flex-start;
            overflow: hidden;
        }
        
        .message.ai .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* í•™ìƒ ë§í’ì„  (ì˜¤ë¥¸ìª½, íŒŒë€ìƒ‰) */
        .message.user .message-bubble {
            background: #3b82f6;
            color: white;
            border-bottom-right-radius: 8px;
            margin-right: 50px;
        }

        .message.user .avatar {
            width: 36px;
            height: 36px;
            background: #60a5fa;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-left: 12px;
            align-self: flex-start;
        }

        /* ì‹œê°„ í‘œì‹œ */
        .message-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
            text-align: right;
        }

        .message.ai .message-time {
            text-align: left;
            margin-left: 50px;
        }

        .message.user .message-time {
            text-align: right;
            margin-right: 50px;
        }

        /* íŠ¹ë³„í•œ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .system-message {
            text-align: center;
            margin: 20px 0;
        }

        .system-message .message-bubble {
            background: #f3f4f6;
            color: #6b7280;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 13px;
            display: inline-block;
            max-width: 80%;
        }

        /* ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° */
        .image-preview-message {
            max-width: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .image-preview-message img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .inline-button {
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin: 8px 4px 0 0;
            transition: background 0.2s;
        }

        .inline-button:hover {
            background: #4338ca;
        }

        .inline-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* ìˆ˜í•™ ê·¸ë˜í”„/ë„í˜• ì‹œê°í™” ì˜ì—­ */
        .math-visual {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9ff;
            border: 2px dashed #e0e7ff;
            border-radius: 12px;
            text-align: center;
        }
        
        .math-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 10px 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* ê°œë… ì„¤ëª… ë°•ìŠ¤ */
        .concept-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }
        
        .concept-box::before {
            content: 'ğŸ’¡';
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
        }
        
        .concept-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .concept-content {
            font-size: 14px;
            line-height: 1.5;
        }

        /* ì‹œê°í™” ì„¤ëª… í…ìŠ¤íŠ¸ */
        .visual-description {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 14px;
            color: #92400e;
        }

        .visual-description::before {
            content: 'ğŸ‘ï¸ ';
            font-weight: bold;
        }

        /* í•˜ë‹¨ ì…ë ¥ ì˜ì—­ */
        .chat-input-container {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 15px 20px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 22px;
            padding: 12px 50px 12px 16px;
            font-size: 15px;
            font-family: inherit;
            outline: none;
            resize: none;
            max-height: 100px;
            min-height: 44px;
            line-height: 1.4;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            border-color: #4f46e5;
        }

        .chat-input:disabled {
            background-color: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .input-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 4px;
        }

        .input-button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .input-button:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .input-button.primary {
            background: #4f46e5;
            color: white;
        }

        .input-button.primary:hover {
            background: #4338ca;
        }

        .input-button:disabled {
            background: #f9fafb;
            color: #d1d5db;
            cursor: not-allowed;
        }

        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ìˆ¨ê²¨ì§„ ìš”ì†Œë“¤ */
        .hidden {
            display: none !important;
        }

        /* ì§„í–‰ë¥  í‘œì‹œ */
        .progress-message {
            text-align: center;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 12px;
            margin: 16px;
            color: #0ea5e9;
            font-weight: 500;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85%;
            }
            
            .chat-header {
                padding: 12px 15px;
            }
            
            .chat-messages {
                padding: 15px;
            }
            
            .chat-input-container {
                padding: 12px 15px;
            }
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ìˆ¨ê¹€ */
        .file-input-hidden {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        /* API í‚¤ ì„¤ì • ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1f2937;
        }

        .modal-description {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            outline: none;
            margin-bottom: 16px;
            font-family: inherit;
        }

        .modal-input:focus {
            border-color: #4f46e5;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-button.primary {
            background: #4f46e5;
            color: white;
        }

        .modal-button.primary:hover {
            background: #4338ca;
        }

        .modal-button.secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-button.secondary:hover {
            background: #e5e7eb;
        }

        /* ì—ëŸ¬ ë©”ì‹œì§€ */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 14px;
        }

        /* ì§ˆë¬¸ êµ¬ë¶„ì„  */
        .question-divider {
            text-align: center;
            margin: 30px 0 20px 0;
            position: relative;
        }

        .question-divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #e5e7eb;
            z-index: 1;
        }

        .question-divider-text {
            background: #f5f5f5;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            position: relative;
            z-index: 2;
            display: inline-block;
        }


    </style>
</head>
<body>
    <!-- í—¤ë” -->
    <div class="chat-header">
        <div class="tutor-profile">
            <img src="ì½´ë‹¤AI ë³µìŠµì½”ì¹˜.png" alt="AI ìˆ˜í•™ íŠœí„°" onerror="this.style.display='none'; this.parentNode.innerHTML='ğŸ§ ';">
        </div>
        <h1>AI ìˆ˜í•™ íŠœí„°</h1>
    </div>

    <!-- ì±„íŒ… ì»¨í…Œì´ë„ˆ -->
    <div class="chat-container">
        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="chat-messages" id="chatMessages">
            <!-- ì´ˆê¸° í™˜ì˜ ë©”ì‹œì§€ëŠ” JavaScriptì—ì„œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- í•˜ë‹¨ ì…ë ¥ ì˜ì—­ -->
        <div class="chat-input-container">
            <div class="input-wrapper">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    rows="1"
                ></textarea>
                <div class="input-actions">
                    <button id="imageButton" class="input-button" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ">ğŸ“·</button>
                    <button id="sendButton" class="input-button primary" title="ì „ì†¡">ğŸ“¤</button>
                </div>
            </div>
            <input type="file" id="imageInput" class="file-input-hidden" accept="image/*">
        </div>
    </div>

    <!-- API í‚¤ ì„¤ì • ëª¨ë‹¬ -->
    <div id="apiModal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="modal-title">ğŸ”‘ OpenAI API í‚¤ ì„¤ì •</h2>
            <div class="modal-description">
                Vision AI ì´ë¯¸ì§€ ë¶„ì„ì„ ìœ„í•´ OpenAI API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br>
                <small>API í‚¤ëŠ” ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small>
            </div>
            <input type="password" id="apiKeyInput" class="modal-input" placeholder="sk-..." />
            <div id="apiError" class="error-message hidden"></div>
            <div class="modal-buttons">
                <button onclick="setApiKey()" class="modal-button primary">ì„¤ì •í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // OpenAI í´ë¼ì´ì–¸íŠ¸ ë˜í¼ í´ë˜ìŠ¤
        class OpenAIClient {
            constructor(apiKey) {
                this.apiKey = apiKey;
                this.baseURL = 'https://api.openai.com/v1';
            }

            async chat_completions_create(options) {
                const response = await fetch(`${this.baseURL}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: options.model,
                        messages: options.messages,
                        max_tokens: options.max_tokens,
                        temperature: options.temperature
                    })
                });

                if (!response.ok) {
                    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                }

                return await response.json();
            }
        }

        // ì „ì—­ ë³€ìˆ˜
        let apiKey = '';
        let openai = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userConcept = '';
        let isOCRProcessing = false;
        let currentPhase = 'setup'; // 'setup', 'concept', 'quiz', 'complete'
        let waitingForAnswer = false;
        let isProcessingMessage = false; // ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ë³µ ë°©ì§€
        let isComposing = false; // í•œê¸€ ì…ë ¥ê¸°(IME) ì¡°í•© ì¤‘ ì—¬ë¶€

        // DOM ìš”ì†Œë“¤
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const imageButton = document.getElementById('imageButton');
        const imageInput = document.getElementById('imageInput');
        const apiModal = document.getElementById('apiModal');

        // í˜„ì¬ ì‹œê°„ ë¬¸ìì—´ ë°˜í™˜
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const ampm = hours < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
            const displayHours = hours % 12 || 12;
            return `${ampm} ${displayHours}:${minutes.toString().padStart(2, '0')}`;
        }

        // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addMessage(content, isUser = false, isSystem = false) {
            const messageDiv = document.createElement('div');
            
            if (isSystem) {
                messageDiv.className = 'system-message';
                messageDiv.innerHTML = `<div class="message-bubble">${content}</div>`;
            } else {
                messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
                const avatar = isUser ? 'ğŸ‘¤' : '<img src="ì½´ë‹¤AI ë³µìŠµì½”ì¹˜.png" alt="AI ìˆ˜í•™ íŠœí„°" onerror="this.outerHTML=\'ğŸ§ \';">'; 
                messageDiv.innerHTML = `
                    <div class="avatar">${avatar}</div>
                    <div class="message-bubble">${content}</div>
                `;
                
                // ì‹œê°„ ì¶”ê°€
                setTimeout(() => {
                    const timeDiv = document.createElement('div');
                    timeDiv.className = 'message-time';
                    timeDiv.textContent = getCurrentTime();
                    messageDiv.appendChild(timeDiv);
                }, 100);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // MathJax ë Œë”ë§ íŠ¸ë¦¬ê±°
            if (window.MathJax) {
                MathJax.typesetPromise([messageDiv]).catch((err) => console.log('MathJax error:', err));
            }
            
            return messageDiv;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì¶”ê°€
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai typing-indicator';
            typingDiv.innerHTML = `
                <div class="avatar"><img src="ì½´ë‹¤AI ë³µìŠµì½”ì¹˜.png" alt="AI ìˆ˜í•™ íŠœí„°" onerror="this.outerHTML='ğŸ§ ';"></div>
                <div class="message-bubble">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return typingDiv;
        }

        // íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° ì œê±°
        function removeTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // API í‚¤ ì„¤ì •
        function setApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            const errorDiv = document.getElementById('apiError');
            
            if (!key) {
                errorDiv.textContent = 'API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (!key.startsWith('sk-')) {
                errorDiv.textContent = 'OpenAI API í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. sk-ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            apiKey = key;
            openai = new OpenAIClient(key);
            localStorage.setItem('openai_api_key', key);
            
            // ëª¨ë‹¬ ë‹«ê¸°
            apiModal.style.display = 'none';
            
            // í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
            addWelcomeMessages();
        }

        // í™˜ì˜ ë©”ì‹œì§€ ì¶”ê°€
        function addWelcomeMessages() {
            setTimeout(() => {
                addMessage('ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹ AI ìˆ˜í•™ íŠœí„°ì…ë‹ˆë‹¤.');
            }, 500);
            
            setTimeout(() => {
                addMessage('êµê³¼ì„œë‚˜ ë…¸íŠ¸ ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì‹œê±°ë‚˜, í•™ìŠµí•œ ë‚´ìš©ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”. ê·¸ëŸ¬ë©´ ì œê°€ ì‹¬í™” ì‚¬ê³ ë ¥ì„ ê¸°ë¥¼ ìˆ˜ ìˆëŠ” ì§ˆë¬¸ë“¤ì„ ë§Œë“¤ì–´ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ“šâœ¨');
            }, 1500);
            
            currentPhase = 'concept';
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if (isProcessingMessage || isComposing) return;
            
            const message = chatInput.value.trim();
            if (!message || isOCRProcessing) return;
            
            // ë¶ˆì™„ì „í•œ í•œê¸€ ìëª¨ìŒë§Œ í•„í„°ë§ (ì™„ì„±ëœ ê¸€ìë‚˜ ìˆ«ì, ì˜ë¬¸ì€ í—ˆìš©)
            if (message.length === 1 && /^[ã„±-ã…ã…-ã…£]$/.test(message)) {
                chatInput.value = '';
                adjustTextareaHeight();  
                return;
            }
            
            // ì²˜ë¦¬ ì¤‘ í”Œë˜ê·¸ ì„¤ì •
            isProcessingMessage = true;
            
            // UI ìƒíƒœ ì—…ë°ì´íŠ¸ (ì²˜ë¦¬ ì¤‘)
            sendButton.disabled = true;
            chatInput.disabled = true;
            
            try {
                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                addMessage(message, true);
                
                // ì…ë ¥ì°½ì„ ì¦‰ì‹œ ì´ˆê¸°í™”
                chatInput.value = '';
                adjustTextareaHeight();
                
                // í˜„ì¬ ë‹¨ê³„ì— ë”°ë¥¸ ì²˜ë¦¬
                if (currentPhase === 'concept') {
                    await handleConceptInput(message);
                } else if (currentPhase === 'quiz') {
                    // í€´ì¦ˆ ì§„í–‰ ì¤‘ì—ëŠ” í•­ìƒ ë‹µë³€ ì²˜ë¦¬ (ì²« ë²ˆì§¸ ë‹µë³€ì´ë“  ì¶”ê°€ ì§ˆë¬¸ì´ë“ )
                    await handleAnswerInput(message);
                }
            } catch (error) {
                console.error('Message processing error:', error);
                addMessage('ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸ˜…');
            } finally {
                // ì²˜ë¦¬ ì™„ë£Œ í›„ í”Œë˜ê·¸ í•´ì œ ë° UI ìƒíƒœ ë³µì›
                isProcessingMessage = false;
                sendButton.disabled = false;
                chatInput.disabled = false;
                chatInput.focus(); // ì…ë ¥ì°½ì— ë‹¤ì‹œ í¬ì»¤ìŠ¤
            }
        }

        // ê°œë… ì…ë ¥ ì²˜ë¦¬ (êµìœ¡ê³¼ì • ê¸°ë°˜ ê°œì„ )
        async function handleConceptInput(concept) {
            userConcept = concept;
            currentPhase = 'quiz';
            
            const typing = addTypingIndicator();
            
            try {
                // 1. í•™ë…„ ìˆ˜ì¤€ ë¶„ì„
                const conceptAnalysis = analyzeConceptLevel(concept);
                
                // 2. GPT APIë¡œ ì§ˆë¬¸ ìƒì„±
                questions = await generateQuestions(concept);
                
                removeTypingIndicator();
                
                if (questions.length === 0) {
                    throw new Error('ì§ˆë¬¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // 3. êµìœ¡ê³¼ì • ê¸°ë°˜ ê°œì„  ë° í•™ë…„ë³„ ì•ˆë‚´
                const enhancement = enhanceQuestionWithCurriculum(concept, questions);
                
                // 4. ê°œì„ ëœ ë©”ì‹œì§€ ì¶œë ¥
                addMessage(`í›Œë¥­í•©ë‹ˆë‹¤! ğŸ“š **${enhancement.analysis.grade} ìˆ˜ì¤€**ì˜ ê°œë…ì„ ë°”íƒ•ìœ¼ë¡œ **ê°œë… ì´í•´ ì¤‘ì‹¬** ë¬¸ì œë“¤ì„ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤.

ğŸ¯ **í•™ìŠµ ëª©í‘œ**: ê²½ì‹œëŒ€íšŒ ìŠ¤íƒ€ì¼ì´ ì•„ë‹Œ, ì‹¤ìƒí™œê³¼ ì—°ê²°ëœ ê¹Šì´ ìˆëŠ” ì´í•´
ğŸ“Š **ì ì • ì—°ë ¹**: ${enhancement.analysis.appropriateAge}  
ğŸ” **í•™ìŠµ ë°©ì‹**: ì‹œê°ì  ìë£Œì™€ ë‹¨ê³„ë³„ ì‚¬ê³ ë¡œ ì§„í–‰

ì°¨ê·¼ì°¨ê·¼ ê°™ì´ íƒêµ¬í•´ë³´ì‹œì£ ! ğŸš€`);
                
                // ì²« ë²ˆì§¸ ì§ˆë¬¸ ì‹œì‘
                currentQuestionIndex = 0;
                setTimeout(() => {
                    displayQuestion();
                }, 1000);
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Error starting quiz:', error);
                addMessage('ì§ˆë¬¸ì„ ë§Œë“œëŠ” ì¤‘ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì‹œê±°ë‚˜ API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. ğŸ˜…');
                currentPhase = 'concept';
            }
        }

        // ì§ˆë¬¸ êµ¬ë¶„ì„  ì¶”ê°€
        function addQuestionDivider() {
            const questionNumber = currentQuestionIndex + 1;
            const dividerDiv = document.createElement('div');
            dividerDiv.className = 'question-divider';
            dividerDiv.innerHTML = `<div class="question-divider-text">ì§ˆë¬¸ ${questionNumber}</div>`;
            chatMessages.appendChild(dividerDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ì§ˆë¬¸ í‘œì‹œ
        function displayQuestion() {
            setTimeout(() => {
                // ëª¨ë“  ì§ˆë¬¸ì— êµ¬ë¶„ì„  ì¶”ê°€
                addQuestionDivider();
                
                addMessage(questions[currentQuestionIndex]);
                waitingForAnswer = true;
            }, 500);
        }

        // ë‹µë³€ ì…ë ¥ ì²˜ë¦¬
        async function handleAnswerInput(answer) {
            const typing = addTypingIndicator();
            
            try {
                // 'ë‹¤ìŒ' ì…ë ¥ ì²´í¬
                if (answer.trim().toLowerCase() === 'ë‹¤ìŒ') {
                    removeTypingIndicator();
                    
                    if (currentQuestionIndex === questions.length - 1) {
                        // ë§ˆì§€ë§‰ ì§ˆë¬¸ ì™„ë£Œ
                        finishQuiz();
                    } else {
                        // ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™
                        currentQuestionIndex++;
                        displayQuestion();
                    }
                    return;
                }
                
                // ì¼ë°˜ ë‹µë³€ì´ë‚˜ ì¶”ê°€ ì§ˆë¬¸ ì²˜ë¦¬
                if (waitingForAnswer) {
                    // ì²« ë²ˆì§¸ ë‹µë³€: í”¼ë“œë°± ì œê³µ
                    const feedback = await generateFeedback(questions[currentQuestionIndex], answer);
                    removeTypingIndicator();
                    
                    let nextInstruction = "\n\në” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”.";
                    
                    addMessage(feedback + nextInstruction);
                    waitingForAnswer = false; // ì´ì œ ì¶”ê°€ ì§ˆë¬¸ë„ ë°›ì„ ìˆ˜ ìˆìŒ
                } else {
                    // ì¶”ê°€ ì§ˆë¬¸: í•´ë‹¹ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ ì œê³µ
                    const followUpAnswer = await generateFollowUpAnswer(questions[currentQuestionIndex], answer);
                    removeTypingIndicator();
                    addMessage(followUpAnswer + "\n\në” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”.");
                }
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Error processing answer:', error);
                addMessage('ë‹µë³€ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì— ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸ˜…');
            }
        }

        // ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™
        function nextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        // ì¶”ê°€ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ ìƒì„±
        async function generateFollowUpAnswer(originalQuestion, followUpQuestion) {
            const prompt = `ë‹¹ì‹ ì€ ì¹œê·¼í•˜ê³  ì •í™•í•œ ìˆ˜í•™ ì„ ìƒë‹˜ì…ë‹ˆë‹¤. í•™ìƒì˜ ì¶”ê°€ ì§ˆë¬¸ì— ëŒ€í•´ ìì—°ìŠ¤ëŸ½ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.

**ì›ë˜ ì§ˆë¬¸:** ${originalQuestion}
**í•™ìƒì˜ ì¶”ê°€ ì§ˆë¬¸:** ${followUpQuestion}

**ë‹µë³€ ì§€ì¹¨:**
- ì›ë˜ ë¬¸ì œì™€ ì—°ê´€ì§€ì–´ì„œ ì„¤ëª…í•˜ì„¸ìš”
- ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ì²´ë¡œ ì¹œê·¼í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”
- ìˆ˜ì‹ì´ë‚˜ ê³„ì‚°ì´ í•„ìš”í•˜ë©´ ë‹¨ê³„ì ìœ¼ë¡œ ì‰½ê²Œ ì„¤ëª…í•˜ì„¸ìš”
- êµ¬ì²´ì ì¸ ì˜ˆì‹œë‚˜ ìˆ«ìë¥¼ ë“¤ì–´ ì„¤ëª…í•˜ì„¸ìš”

**âš ï¸ ì¼ê´€ì„± ì¤‘ìš”:** 
- ì´ì „ì— ì œê³µí•œ í”¼ë“œë°±ê³¼ ëª¨ìˆœë˜ì§€ ì•Šê²Œ ë‹µë³€í•˜ì„¸ìš”
- ê°™ì€ ë¬¸ì œì— ëŒ€í•´ì„œëŠ” í•­ìƒ ê°™ì€ ê²°ë¡ ì„ ìœ ì§€í•˜ì„¸ìš”
- ê³„ì‚°ì„ ë‹¤ì‹œ í™•ì¸í•˜ê³  ì •í™•í•œ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”

**ë‹µë³€ ì˜ˆì‹œ:**
"ì•„, ì¢‹ì€ ì§ˆë¬¸ì´ë„¤ìš”! ğŸ˜Š íŒë³„ì‹ì´ ìŒìˆ˜ê°€ ë‚˜ì˜¤ëŠ” ì´ìœ ë¥¼ ì„¤ëª…í•´ë“œë¦´ê²Œìš”.

ì•ì„œ ë¬¸ì œì—ì„œ ë‘ í•¨ìˆ˜ë¥¼ ì—°ë¦½í•˜ë©´ xÂ² - 4x + 5 = 0ì´ ë‚˜ì™”ì–ì•„ìš”? ì´ë•Œ íŒë³„ì‹ D = bÂ² - 4ac = 16 - 20 = -16ì´ ë©ë‹ˆë‹¤. 

íŒë³„ì‹ì´ ìŒìˆ˜ë¼ëŠ” ê±´ ì´ì°¨ë°©ì •ì‹ì˜ í•´ê°€ ì‹¤ìˆ˜ ë²”ìœ„ì—ì„œ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ëœ»ì´ì—ìš”. ì‰½ê²Œ ë§í•´ì„œ xì¶•ê³¼ ë§Œë‚˜ëŠ” ì ì´ ì—†ë‹¤ëŠ” ê±°ì£ . ê·¸ë˜í”„ë¡œ ìƒê°í•´ë³´ë©´ í¬ë¬¼ì„ ì´ xì¶• ìœ„ì— ë–  ìˆëŠ” ìƒíƒœë¼ê³  ë³´ì‹œë©´ ë©ë‹ˆë‹¤.

ë”°ë¼ì„œ ë‘ í•¨ìˆ˜ì˜ êµì ë„ ì‹¤ì œë¡œëŠ” ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê±°ì˜ˆìš”. ê·¸ë˜ì„œ 'êµì ì˜ xì¢Œí‘œê°€ ìŒìˆ˜'ë¼ëŠ” ì¡°ê±´ ìì²´ê°€ ë¶ˆê°€ëŠ¥í•œ ìƒí™©ì¸ ì…ˆì´ì£ !"

**ì¤‘ìš”í•œ ì :**
- ìˆ˜ì‹ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì„¤ëª…ì— í¬í•¨ì‹œí‚¤ì„¸ìš”
- ë¹„ìœ ë‚˜ ê·¸ë˜í”„ ì„¤ëª…ì„ í™œìš©í•˜ì„¸ìš”  
- í•™ìƒì´ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•˜ì„¸ìš”
- ìì—°ìŠ¤ëŸ½ê³  ì¹œê·¼í•œ í†¤ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”

**âœ… ìˆ˜í•™ ê¸°í˜¸ ì‚¬ìš©ë²•:**
- ëª¨ë“  ìˆ˜í•™ì‹ì€ $...$ ì•ˆì— ì‘ì„±í•˜ì„¸ìš”
- ì˜ˆ: $\\triangle ABC$, $\\angle A = 60^\\circ$, $f(x) = x^2 + 1$
- ë¶„ìˆ˜: $\\frac{a}{b}$, ì œê³±ê·¼: $\\sqrt{x}$, ê·¹í•œ: $\\lim_{x \\to 0} f(x)$`;

            try {
                const response = await openai.chat_completions_create({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 800,
                    temperature: 0.7
                });

                return response.choices[0].message.content;
                
            } catch (error) {
                console.error('GPT API Error:', error);
                throw error;
            }
        }

        // í€´ì¦ˆ ì™„ë£Œ
        function finishQuiz() {
            currentPhase = 'complete';
            
            setTimeout(() => {
                addMessage('ğŸ† ëª¨ë“  ì§ˆë¬¸ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤! ì •ë§ í›Œë¥­í•˜ì…¨ìŠµë‹ˆë‹¤!');
            }, 500);
            
            setTimeout(() => {
                addMessage('ìƒˆë¡œìš´ í•™ìŠµ ë‚´ìš©ìœ¼ë¡œ ë‹¤ì‹œ ë„ì „í•´ë³´ì‹œê² ìŠµë‹ˆê¹Œ? ìƒˆë¡œìš´ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì‹œë©´ ì–¸ì œë“  ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ’ª');
                currentPhase = 'concept';
                currentQuestionIndex = 0;
                questions = [];
            }, 2000);
        }

        // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleImageUpload(file) {
            if (!file || !file.type.startsWith('image/')) {
                addMessage('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì˜¬ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ“·', false);
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                addMessage('íŒŒì¼ì´ ë„ˆë¬´ ì»¤ìš”. 10MB ì´í•˜ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”. ğŸ“', false);
                return;
            }

            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
            const reader = new FileReader();
            reader.onload = function(e) {
                const imagePreview = `<div class="image-preview-message"><img src="${e.target.result}" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€"></div>ì‚¬ì§„ì„ ì˜¬ë ¤ì£¼ì…¨ë„¤ìš”! AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ë³´ê² ìŠµë‹ˆë‹¤...`;
                addMessage(imagePreview, true);
                
                // API í‚¤ê°€ ìˆìœ¼ë©´ Vision APIë¡œ ë¶„ì„
                if (apiKey) {
                    analyzeImageConcept(file);
                } else {
                    addMessage('AI ì´ë¯¸ì§€ ë¶„ì„ì„ ìœ„í•´ ë¨¼ì € API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”! ğŸ”‘');
                    performOCR(file);
                }
            };
            reader.readAsDataURL(file);
        }

        // Vision APIë¡œ ì´ë¯¸ì§€ ê°œë… ë¶„ì„
        async function analyzeImageConcept(file) {
            if (isOCRProcessing) return;
            
            isOCRProcessing = true;
            const typing = addTypingIndicator();
            
            try {
                const base64Image = await fileToBase64(file);
                
                const response = await openai.chat_completions_create({
                    model: 'gpt-4o-mini',
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: `ì´ ìˆ˜í•™ ë¬¸ì œë¥¼ ìì„¸íˆ ë¶„ì„í•´ì£¼ì„¸ìš”:

**1ë‹¨ê³„: ë¬¸ì œ ë‚´ìš© íŒŒì•…**
- ë¬¸ì œì—ì„œ ë¬´ì—‡ì„ ë¬»ê³  ìˆëŠ”ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…
- ì£¼ì–´ì§„ ì¡°ê±´ì´ë‚˜ ìƒí™© íŒŒì•…
- ì‚¬ìš©ëœ ìˆ˜í•™ì  ê°œë…ì´ë‚˜ ê³µì‹ í™•ì¸

**2ë‹¨ê³„: í•µì‹¬ ê°œë… ì¶”ì¶œ**
- ì´ ë¬¸ì œê°€ ë‹¤ë£¨ëŠ” í•µì‹¬ ìˆ˜í•™ ê°œë… (ì˜ˆ: ì´ì°¨í•¨ìˆ˜, ê·¹í•œ, ë¯¸ë¶„, ì‚¼ê°í•¨ìˆ˜ ë“±)
- ë¬¸ì œ í•´ê²°ì— í•„ìš”í•œ ì£¼ìš” ìˆ˜í•™ì  ì›ë¦¬ë‚˜ ì„±ì§ˆ

**3ë‹¨ê³„: í•´ê²° ê³¼ì • ë° ì‘ìš© í¬ì¸íŠ¸**
- ë¬¸ì œ í•´ê²°ì˜ í•µì‹¬ ì•„ì´ë””ì–´ë‚˜ ì ‘ê·¼ë²•
- ì´ ë¬¸ì œì™€ ìœ ì‚¬í•œ ìƒí™©ì´ë‚˜ ì‘ìš© ê°€ëŠ¥í•œ ë‹¤ë¥¸ ê²½ìš°ë“¤
- í•™ìƒë“¤ì´ í—·ê°ˆë¦´ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ë‚˜ ì£¼ì˜ì‚¬í•­

**ì¶œë ¥ í˜•ì‹:**
í•µì‹¬ ê°œë…: [ë©”ì¸ ìˆ˜í•™ ê°œë…]
ë¬¸ì œ ìœ í˜•: [êµ¬ì²´ì ì¸ ë¬¸ì œ ìœ í˜•]
í•´ê²° í¬ì¸íŠ¸: [í•µì‹¬ í•´ê²° ë°©ë²•ì´ë‚˜ ì•„ì´ë””ì–´]
ì‘ìš© ë²”ìœ„: [ê´€ë ¨ëœ ë‹¤ë¥¸ ìƒí™©ì´ë‚˜ í™•ì¥ ê°œë…ë“¤]

ì˜ˆì‹œ:
í•µì‹¬ ê°œë…: ì´ì°¨í•¨ìˆ˜ì˜ ìµœëŒ“ê°’ê³¼ ìµœì†Ÿê°’
ë¬¸ì œ ìœ í˜•: ì´ì°¨í•¨ìˆ˜ f(x) = axÂ² + bx + cì—ì„œ ì£¼ì–´ì§„ êµ¬ê°„ì—ì„œì˜ ìµœëŒ“ê°’ êµ¬í•˜ê¸°
í•´ê²° í¬ì¸íŠ¸: ëŒ€ì¹­ì¶•ê³¼ êµ¬ê°„ì˜ ìœ„ì¹˜ ê´€ê³„ë¥¼ íŒŒì•…í•˜ì—¬ ê²½ìš°ë¥¼ ë‚˜ëˆ„ì–´ í•´ê²°
ì‘ìš© ë²”ìœ„: ì‹¤ìƒí™œ ìµœì í™” ë¬¸ì œ, ë„í•¨ìˆ˜ë¥¼ ì´ìš©í•œ ìµœëŒ“ê°’ ë¬¸ì œ, ì´ì°¨ë¶€ë“±ì‹ê³¼ì˜ ì—°ê´€ì„±

ìœ„ í˜•ì‹ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.`
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    max_tokens: 800
                });

                const analysisResult = response.choices[0].message.content.trim();
                
                removeTypingIndicator();
                
                // ë¶„ì„ ê²°ê³¼ë¥¼ íŒŒì‹±í•˜ì—¬ í•µì‹¬ ì •ë³´ ì¶”ì¶œ
                const conceptMatch = analysisResult.match(/í•µì‹¬ ê°œë…:\s*(.+)/);
                const typeMatch = analysisResult.match(/ë¬¸ì œ ìœ í˜•:\s*(.+)/);
                const pointMatch = analysisResult.match(/í•´ê²° í¬ì¸íŠ¸:\s*(.+)/);
                const applicationMatch = analysisResult.match(/ì‘ìš© ë²”ìœ„:\s*(.+)/);
                
                const concept = conceptMatch ? conceptMatch[1].trim() : 'ìˆ˜í•™ ê°œë…';
                const problemType = typeMatch ? typeMatch[1].trim() : '';
                const solutionPoint = pointMatch ? pointMatch[1].trim() : '';
                const applicationRange = applicationMatch ? applicationMatch[1].trim() : '';
                
                // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                addMessage(`âœ… ${concept} ë¬¸ì œë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.`);
                
                if (problemType) {
                    setTimeout(() => {
                        addMessage(`ğŸ“‹ ë¬¸ì œ ìœ í˜•: ${problemType}`);
                    }, 1000);
                }
                
                if (solutionPoint) {
                    setTimeout(() => {
                        addMessage(`ğŸ’¡ í•´ê²° í¬ì¸íŠ¸: ${solutionPoint}`);
                    }, 2000);
                }
                
                if (applicationRange) {
                    setTimeout(() => {
                        addMessage(`ğŸ”„ ì‘ìš© ë²”ìœ„: ${applicationRange}`);
                    }, 3000);
                }
                
                // ìë™ìœ¼ë¡œ ì‘ìš© ê°œë… ì§ˆë¬¸ ìƒì„± ì‹œì‘
                setTimeout(() => {
                    addMessage('ì´ì œ ì´ ê°œë…ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ìš© ì‚¬ê³ ë ¥ ì§ˆë¬¸ë“¤ì„ ë§Œë“¤ì–´ë³´ê² ìŠµë‹ˆë‹¤! ğŸ¯');
                    handleConceptInput(analysisResult);
                }, 4500);
                
            } catch (error) {
                removeTypingIndicator();
                console.error('Vision Analysis Error:', error);
                addMessage('AI ë¶„ì„ì´ ì˜ ì•ˆ ë˜ë„¤ìš”. ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì‹œë„í•´ë³´ê² ìŠµë‹ˆë‹¤! ğŸ”„');
                
                // ì‹¤íŒ¨ ì‹œ OCRë¡œ ëŒ€ì²´
                setTimeout(() => {
                    performOCR(file);
                }, 1000);
            }
            
            isOCRProcessing = false;
        }

        // OCR í…ìŠ¤íŠ¸ ì¸ì‹
        async function performOCR(file) {
            if (isOCRProcessing) return;
            
            isOCRProcessing = true;
            const typing = addTypingIndicator();
            
            try {
                removeTypingIndicator();
                addMessage('í…ìŠ¤íŠ¸ë¥¼ ì½ê³  ìˆìŠµë‹ˆë‹¤... ğŸ“–');
                const newTyping = addTypingIndicator();
                
                const { data: { text } } = await Tesseract.recognize(
                    file,
                    'kor+eng',
                    {
                        tessedit_pageseg_mode: Tesseract.PSM.AUTO_OSD,
                        tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzê°€-í£+-*/=()[]{}^âˆšâˆâˆ‘âˆ«â‰¤â‰¥â‰ â†’â†â†‘â†“Â°â€²â€³Î±Î²Î³Î´ÎµÎ¶Î·Î¸Î¹ÎºÎ»Î¼Î½Î¾Î¿Ï€ÏÏƒÏ„Ï…Ï†Ï‡ÏˆÏ‰âˆ€âˆƒâˆˆâˆ‰âŠ‚âŠƒâˆªâˆ©âˆ…â„â„‚â„•â„¤â„šâˆ´âˆµâˆâˆ¼â‰…â‰¡âˆâˆ âŠ¥âˆ¥âŸ‚â–³â–²â–¼â–¶â—€â—â—‹â– â–¡â˜…â˜†',
                        preserve_interword_spaces: '1'
                    }
                );
                
                // ìˆ˜í•™ ê¸°í˜¸ í›„ì²˜ë¦¬
                let cleanedText = text
                    .replace(/"/g, 'Â²')
                    .replace(/'/g, 'â€²')
                    .replace(/â€”/g, '-')
                    .replace(/â€“/g, '-')
                    .replace(/\|/g, '1')
                    .replace(/O/g, '0')
                    .replace(/l/g, '1')
                    .replace(/\s*x\s*/g, 'Ã—')
                    .replace(/\s*\*\s*/g, 'Ã—')
                    .replace(/\/\s*/g, 'Ã·')
                    .replace(/<=|â‰¤/g, 'â‰¤')
                    .replace(/>=|â‰¥/g, 'â‰¥')
                    .replace(/!=/g, 'â‰ ')
                    .replace(/\s+/g, ' ')
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .join('\n');
                
                removeTypingIndicator();
                
                if (cleanedText.trim()) {
                    addMessage(`ğŸ“ í…ìŠ¤íŠ¸ ì¸ì‹ ì™„ë£Œ!\n\n${cleanedText}\n\nì´ ë‚´ìš©ìœ¼ë¡œ ì§ˆë¬¸ì„ ë§Œë“¤ì–´ë“œë¦´ê¹Œìš”?`);
                    
                    // ìë™ìœ¼ë¡œ í€´ì¦ˆ ì‹œì‘
                    setTimeout(() => {
                        handleConceptInput(cleanedText);
                    }, 2000);
                } else {
                    throw new Error('í…ìŠ¤íŠ¸ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                removeTypingIndicator();
                console.error('OCR Error:', error);
                addMessage('ì´ë¯¸ì§€ì—ì„œ ê¸€ìë¥¼ ì½ê¸° ì–´ë µìŠµë‹ˆë‹¤. ë” ì„ ëª…í•œ ì‚¬ì§„ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”. ğŸ˜…');
            }
            
            isOCRProcessing = false;
        }

        // ì‹œê°ì  ìš”ì†Œ ìƒì„± í•¨ìˆ˜ë“¤
        function createMathVisual(type, data) {
            const visualDiv = document.createElement('div');
            visualDiv.className = 'math-visual';
            
            switch(type) {
                case 'graph':
                    return createGraphVisual(visualDiv, data);
                case 'geometry':
                    return createGeometryVisual(visualDiv, data);
                case 'concept':
                    return createConceptBox(visualDiv, data);
                default:
                    return null;
            }
        }
        
        function createGraphVisual(container, data) {
            const canvas = document.createElement('canvas');
            canvas.className = 'math-canvas';
            canvas.width = 400;
            canvas.height = 300;
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // ì¢Œí‘œê³„ ê·¸ë¦¬ê¸°
            drawCoordinateSystem(ctx, canvas.width, canvas.height);
            
            // í•¨ìˆ˜ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
            if (data.function) {
                drawFunction(ctx, data.function, canvas.width, canvas.height);
            }
            
            return container;
        }
        
        function createGeometryVisual(container, data) {
            const canvas = document.createElement('canvas');
            canvas.className = 'math-canvas';
            canvas.width = 300;
            canvas.height = 300;
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // ë„í˜• ê·¸ë¦¬ê¸°
            if (data.shape === 'triangle') {
                drawTriangle(ctx, data);
            } else if (data.shape === 'circle') {
                drawCircle(ctx, data);
            }
            
            return container;
        }
        
        function createConceptBox(container, data) {
            container.className = 'concept-box';
            container.innerHTML = `
                <div class="concept-title">${data.title}</div>
                <div class="concept-content">${data.content}</div>
            `;
            return container;
        }
        
        // ì¢Œí‘œê³„ ê·¸ë¦¬ê¸°
        function drawCoordinateSystem(ctx, width, height) {
            const centerX = width / 2;
            const centerY = height / 2;
            
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // Xì¶•
            ctx.beginPath();
            ctx.moveTo(0, centerY);
            ctx.lineTo(width, centerY);
            ctx.stroke();
            
            // Yì¶•
            ctx.beginPath();
            ctx.moveTo(centerX, 0);
            ctx.lineTo(centerX, height);
            ctx.stroke();
            
            // ëˆˆê¸ˆ
            ctx.strokeStyle = '#eee';
            for (let i = -5; i <= 5; i++) {
                if (i !== 0) {
                    const x = centerX + i * 30;
                    const y = centerY + i * 30;
                    
                    // ì„¸ë¡œ ëˆˆê¸ˆì„ 
                    if (x >= 0 && x <= width) {
                        ctx.beginPath();
                        ctx.moveTo(x, 0);
                        ctx.lineTo(x, height);
                        ctx.stroke();
                    }
                    
                    // ê°€ë¡œ ëˆˆê¸ˆì„ 
                    if (y >= 0 && y <= height) {
                        ctx.beginPath();
                        ctx.moveTo(0, y);
                        ctx.lineTo(width, y);
                        ctx.stroke();
                    }
                }
            }
        }
        
        // í•¨ìˆ˜ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        function drawFunction(ctx, func, width, height) {
            const centerX = width / 2;
            const centerY = height / 2;
            const scale = 30;
            
            ctx.strokeStyle = '#4f46e5';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            let firstPoint = true;
            for (let screenX = 0; screenX < width; screenX += 2) {
                const mathX = (screenX - centerX) / scale;
                const mathY = func(mathX);
                const screenY = centerY - mathY * scale;
                
                if (screenY >= 0 && screenY <= height) {
                    if (firstPoint) {
                        ctx.moveTo(screenX, screenY);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(screenX, screenY);
                    }
                }
            }
            ctx.stroke();
        }
        
        // ì‚¼ê°í˜• ê·¸ë¦¬ê¸°
        function drawTriangle(ctx, data) {
            const centerX = 150;
            const centerY = 150;
            
            ctx.strokeStyle = '#4f46e5';
            ctx.fillStyle = 'rgba(79, 70, 229, 0.1)';
            ctx.lineWidth = 2;
            
            // ì‚¼ê°í˜• ì¢Œí‘œ
            const A = { x: centerX, y: centerY - 50 };
            const B = { x: centerX - 60, y: centerY + 50 };
            const C = { x: centerX + 60, y: centerY + 50 };
            
            // ì‚¼ê°í˜• ê·¸ë¦¬ê¸°
            ctx.beginPath();
            ctx.moveTo(A.x, A.y);
            ctx.lineTo(B.x, B.y);
            ctx.lineTo(C.x, C.y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // ê¼­ì§“ì  ë¼ë²¨
            ctx.fillStyle = '#333';
            ctx.font = '16px Arial';
            ctx.fillText('A', A.x - 10, A.y - 10);
            ctx.fillText('B', B.x - 20, B.y + 20);
            ctx.fillText('C', C.x + 10, C.y + 20);
        }
        
        // ì› ê·¸ë¦¬ê¸°
        function drawCircle(ctx, data) {
            const centerX = 150;
            const centerY = 150;
            const radius = data.radius || 50;
            
            ctx.strokeStyle = '#4f46e5';
            ctx.fillStyle = 'rgba(79, 70, 229, 0.1)';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
            
            // ë°˜ì§€ë¦„ í‘œì‹œ
            ctx.strokeStyle = '#333';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + radius, centerY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText(`r = ${data.radius || 'r'}`, centerX + radius/2 - 10, centerY - 10);
        }

        // GPT APIë¡œ ì§ˆë¬¸ ìƒì„± (ê°œì„ ëœ ë²„ì „)
        async function generateQuestions(concept) {
            const prompt = `ë‹¹ì‹ ì€ ì¤‘ê³ ë“±í•™ìƒì„ ìœ„í•œ ìˆ˜í•™ êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. 2022 ê°œì • êµìœ¡ê³¼ì •ì— ë§ì¶° **ê°œë… ì´í•´ ì¤‘ì‹¬**ì˜ ë¬¸ì œë¥¼ ìƒì„±í•˜ì„¸ìš”.

**í•™ìŠµ ë‚´ìš© ë¶„ì„:**
${concept}

**ğŸ¯ í•µì‹¬ êµìœ¡ ëª©í‘œ: ê¹Šì´ ìˆëŠ” ê°œë… ì´í•´**

**ğŸš« ê²½ì‹œëŒ€íšŒ/ì˜¬ë¦¼í”¼ì•„ë“œ ìŠ¤íƒ€ì¼ ê¸ˆì§€:**
- "ëª¨ìˆœì„ ì°¾ìœ¼ì„¸ìš”", "ë¶ˆê°€ëŠ¥í•œ ì¡°ê±´", "ì˜¤ë¥˜ë¥¼ ë°œê²¬í•˜ì„¸ìš”" ê°™ì€ íŠ¸ë¦­ ë¬¸ì œ NO
- ë³µì¡í•œ ê³„ì‚°ì´ë‚˜ ì–´ë ¤ìš´ ê³µì‹ ì•”ê¸° ìœ„ì£¼ ë¬¸ì œ NO
- í•™ë…„ ìˆ˜ì¤€ì„ ë²—ì–´ë‚˜ëŠ” ê³ ë‚œë„ ë¬¸ì œ NO

**âœ… ê°œë… ì´í•´ ì¤‘ì‹¬ ë¬¸ì œ ì›ì¹™:**
1. **ì‹¤ìƒí™œ ì—°ê²°**: ì¼ìƒì—ì„œ ë§Œë‚  ìˆ˜ ìˆëŠ” ìƒí™©ê³¼ ìˆ˜í•™ ê°œë… ì—°ê²°
2. **ë‹¨ê³„ë³„ ì‚¬ê³ **: ì‘ì€ ë‹¨ê³„ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ì´í•´í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°
3. **ì‹œê°ì  ì´í•´**: ê·¸ë˜í”„, ë„í˜•, í‘œ ë“±ìœ¼ë¡œ ì‹œê°í™” ê°€ëŠ¥í•œ ë¬¸ì œ
4. **ê°œë… ì ìš©**: ê³µì‹ ì•”ê¸°ê°€ ì•„ë‹Œ, ì™œ ê·¸ëŸ°ì§€ ì´í•´í•˜ê³  ì ìš©í•˜ëŠ” ë¬¸ì œ
5. **í•™ë…„ ì í•©ì„±**: í•´ë‹¹ í•™ë…„ì—ì„œ ë°°ìš°ëŠ” ê°œë…ë§Œ ì‚¬ìš©
6. **í¥ë¯¸ ìœ ë°œ**: ì¹œìˆ™í•˜ê³  í¥ë¯¸ë¡œìš´ ìƒí™© ì„¤ì •

**âœ… ë¬¸ì œ ìœ í˜•ë³„ ê°€ì´ë“œ:**

**ê¸°í•˜ ë¬¸ì œ (ì‚¼ê°í˜•, ì›, ë‹¤ê°í˜•):**
- ì‹¤ì œ ê±´ë¬¼, ìš´ë™ì¥, ê³µì› ë“±ì˜ ì„¤ê³„ ë¬¸ì œ
- ê·¸ë¦¼ì„ ê·¸ë ¤ì„œ ì´í•´í•  ìˆ˜ ìˆëŠ” ì§ê´€ì  ë¬¸ì œ
- ê°ë„ì™€ ë³€ì˜ ê´€ê³„ë¥¼ ì²´í—˜í•  ìˆ˜ ìˆëŠ” ë¬¸ì œ

**í•¨ìˆ˜ ë¬¸ì œ:**
- ì‹œê°„ì— ë”°ë¥¸ ì˜¨ë„ ë³€í™”, ê±°ë¦¬-ì‹œê°„ ê·¸ë˜í”„ ë“±
- ê·¸ë˜í”„ë¥¼ ë³´ê³  ìƒí™©ì„ í•´ì„í•˜ëŠ” ë¬¸ì œ
- í•¨ìˆ˜ì˜ ì˜ë¯¸ë¥¼ ì‹¤ìƒí™œì—ì„œ ì°¾ëŠ” ë¬¸ì œ

**í™•ë¥ /í†µê³„ ë¬¸ì œ:**
- ê²Œì„, ì¶”ì²¨, ì„¤ë¬¸ì¡°ì‚¬ ë“± ì¹œìˆ™í•œ ìƒí™©
- ë°ì´í„°ë¥¼ í•´ì„í•˜ê³  ì˜ë¯¸ë¥¼ ì°¾ëŠ” ë¬¸ì œ
- ì˜ˆì¸¡ê³¼ ì‹¤ì œ ê²°ê³¼ë¥¼ ë¹„êµí•˜ëŠ” ë¬¸ì œ

**âœ… ê°œë… ì´í•´ ì¤‘ì‹¬ ë¬¸ì œ ì˜ˆì‹œ:**

**ê¸°í•˜ ë¬¸ì œ (ì‹œê°í™” í¬í•¨):**
- "í•™êµ ìš´ë™ì¥ì´ ì§ì‚¬ê°í˜• ëª¨ì–‘ì…ë‹ˆë‹¤. ê°€ë¡œê°€ 60m, ì„¸ë¡œê°€ 40mì¼ ë•Œ, ëŒ€ê°ì„ ìœ¼ë¡œ ë›°ì–´ê°€ë©´ ëª‡ ë¯¸í„°ë¥¼ ë›°ì–´ì•¼ í• ê¹Œìš”? í”¼íƒ€ê³ ë¼ìŠ¤ ì •ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ ê³„ì‚°í•´ë³´ê³ , ì™œ ì§ê°ìœ¼ë¡œ ê°€ëŠ” ê²ƒë³´ë‹¤ ì§§ì€ì§€ ì„¤ëª…í•´ë³´ì„¸ìš”." [VISUAL: ì§ì‚¬ê°í˜• ë„í˜•ê³¼ ëŒ€ê°ì„  í‘œì‹œ]

**í•¨ìˆ˜ ë¬¸ì œ (ê·¸ë˜í”„ í¬í•¨):**
- "ê²¨ìš¸ì²  ì˜¤í›„ 2ì‹œë¶€í„° 6ì‹œê¹Œì§€ ê¸°ì˜¨ ë³€í™”ê°€ $y = -2x + 6$ (xëŠ” 2ì‹œ ì´í›„ ì‹œê°„, yëŠ” ì„­ì”¨ì˜¨ë„)ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ëª‡ ì‹œì— ê¸°ì˜¨ì´ 0ë„ê°€ ë ê¹Œìš”? ê·¸ë˜í”„ë¥¼ ê·¸ë ¤ì„œ í™•ì¸í•´ë³´ì„¸ìš”." [VISUAL: ì¼ì°¨í•¨ìˆ˜ ê·¸ë˜í”„]

**í™•ë¥  ë¬¸ì œ:**
- "ë°˜ì—ì„œ ì¡°ë³„ ë°œí‘œ ìˆœì„œë¥¼ ì •í•˜ëŠ”ë°, 6ê°œ ì¡°ê°€ ìˆìŠµë‹ˆë‹¤. ìš°ë¦¬ ì¡°ê°€ ì²« ë²ˆì§¸ë‚˜ ë‘ ë²ˆì§¸ë¡œ ë°œí‘œí•  í™•ë¥ ì€ ì–¼ë§ˆì¼ê¹Œìš”? ë‹¨ê³„ë³„ë¡œ ê²½ìš°ì˜ ìˆ˜ë¥¼ ì„¸ì–´ë³´ì„¸ìš”."

**ì´ì°¨í•¨ìˆ˜ ë¬¸ì œ (ì‹¤ìƒí™œ ì—°ê²°):**
- "ë†êµ¬ê³µì„ ë˜ì§ˆ ë•Œ ê³µì˜ ë†’ì´ê°€ $h = -5t^2 + 10t + 2$ (tëŠ” ì´ˆ, hëŠ” ë¯¸í„°)ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. ê³µì´ ê°€ì¥ ë†’ì´ ì˜¬ë¼ê°€ëŠ” ì‹œì ê³¼ ë†’ì´ë¥¼ êµ¬í•´ë³´ê³ , ì–¸ì œ ë•…ì— ë–¨ì–´ì§€ëŠ”ì§€ ê³„ì‚°í•´ë³´ì„¸ìš”." [VISUAL: í¬ë¬¼ì„  ê·¸ë˜í”„]

**âŒ ì ˆëŒ€ í”¼í•´ì•¼ í•  ë¬¸ì œ ìŠ¤íƒ€ì¼:**
- ê²½ì‹œëŒ€íšŒ/ì˜¬ë¦¼í”¼ì•„ë“œ ìŠ¤íƒ€ì¼ì˜ íŠ¸ë¦­ ë¬¸ì œ
- "ëª¨ìˆœì„ ì°¾ìœ¼ì„¸ìš”", "ì˜¤ë¥˜ë¥¼ ë°œê²¬í•˜ì„¸ìš”" ê°™ì€ í•¨ì • ë¬¸ì œ
- ë³µì¡í•œ ê³„ì‚°ë§Œ ìš”êµ¬í•˜ëŠ” ë¬¸ì œ
- í•™ë…„ ìˆ˜ì¤€ì„ ë²—ì–´ë‚˜ëŠ” ê³ ê¸‰ ê°œë… í˜¼ìš©
- ê³µì‹ ì•”ê¸°ë§Œìœ¼ë¡œ í’€ ìˆ˜ ìˆëŠ” ê¸°ê³„ì  ë¬¸ì œ

**âœ… ì‹œê°í™” ìš”ì†Œ í¬í•¨ ì§€ì¹¨:**
- ë„í˜• ë¬¸ì œëŠ” ë°˜ë“œì‹œ [VISUAL: ì‚¼ê°í˜•/ì›/ì‚¬ê°í˜• ë“±] í‘œì‹œ
- í•¨ìˆ˜ ë¬¸ì œëŠ” ë°˜ë“œì‹œ [VISUAL: ê·¸ë˜í”„] í‘œì‹œ
- í†µê³„ ë¬¸ì œëŠ” [VISUAL: í‘œ/ì°¨íŠ¸] í‘œì‹œ
- ì‹¤ìƒí™œ ìƒí™©ì€ [VISUAL: ìƒí™© ì„¤ëª… ê·¸ë¦¼] í‘œì‹œ

**ì‘ë‹µ í˜•ì‹:**
ê° ë¬¸ì œë§ˆë‹¤ ë‹¤ìŒ êµ¬ì¡°ë¡œ ì‘ì„±:
1. [ê°œë… ì´í•´ ì¤‘ì‹¬ ì‹¤ìƒí™œ ì—°ê²° ë¬¸ì œ] [VISUAL: ì‹œê°í™” ìœ í˜•]
2. [ë‹¨ê³„ë³„ ì‚¬ê³ ë¥¼ ìœ ë„í•˜ëŠ” ë¬¸ì œ] [VISUAL: ì‹œê°í™” ìœ í˜•]  
3. [ê·¸ë˜í”„/ë„í˜• í•´ì„ ë¬¸ì œ] [VISUAL: ì‹œê°í™” ìœ í˜•]
4. [ì‘ìš© ë° í™•ì¥ ì‚¬ê³  ë¬¸ì œ] [VISUAL: ì‹œê°í™” ìœ í˜•]
5. [ì°½ì˜ì  ë¬¸ì œ í•´ê²° ë¬¸ì œ] [VISUAL: ì‹œê°í™” ìœ í˜•]

**ğŸ¯ ìµœì¢… ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸:**
1. âœ… ê²½ì‹œëŒ€íšŒ ìŠ¤íƒ€ì¼ ì—†ìŒ (ëª¨ìˆœ/í•¨ì •/íŠ¸ë¦­ ë¬¸ì œ ì œê±°)
2. âœ… ì‹¤ìƒí™œ ì—°ê²°ì„± ìˆìŒ
3. âœ… í•™ë…„ ìˆ˜ì¤€ ì í•©ì„± í™•ì¸
4. âœ… ì‹œê°í™” ìš”ì†Œ [VISUAL] íƒœê·¸ í¬í•¨
5. âœ… ê°œë… ì´í•´ì— ì§‘ì¤‘ (ë‹¨ìˆœ ê³„ì‚° ì§€ì–‘)
6. âœ… ë‹¨ê³„ë³„ ì‚¬ê³  ìœ ë„
7. âœ… ì¹œìˆ™í•˜ê³  í¥ë¯¸ë¡œìš´ ìƒí™© ì„¤ì •

**ğŸŒŸ ë¬¸ì œ ìƒì„± ìµœê³  ì›ì¹™:**
"í•™ìƒì´ ì´ ë¬¸ì œë¥¼ í’€ë©´ì„œ ìˆ˜í•™ ê°œë…ì„ ë” ê¹Šì´ ì´í•´í•˜ê³ , ì‹¤ìƒí™œì—ì„œ ìˆ˜í•™ì´ ì–´ë–»ê²Œ ì“°ì´ëŠ”ì§€ ê¹¨ë‹¬ì„ ìˆ˜ ìˆëŠ”ê°€?"

**âœ… ìˆ˜í•™ ê¸°í˜¸ ì‚¬ìš©ë²•:**
- ëª¨ë“  ìˆ˜í•™ì‹ì€ $...$ ì•ˆì— ì‘ì„±í•˜ì„¸ìš”
- ì‚¼ê°í˜•: $\\triangle ABC$, ê°ë„: $\\angle A = 60^\\circ$
- í•¨ìˆ˜: $f(x) = x^2 + 1$, ë¶„ìˆ˜: $\\frac{a}{b}$
- ì œê³±ê·¼: $\\sqrt{x}$, ê·¹í•œ: $\\lim_{x \\to 0} f(x)$`;

            try {
                const response = await openai.chat_completions_create({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 1200,
                    temperature: 0.8
                });

                const content = response.choices[0].message.content;
                
                // ì§ˆë¬¸ ì¶”ì¶œ ë° ì‹œê°í™” ìš”ì†Œ ì²˜ë¦¬
                const questionLines = content.split('\n').filter(line => 
                    line.trim() && /^\d+\./.test(line.trim())
                );
                
                // ì‹œê°í™” ìš”ì†Œê°€ í¬í•¨ëœ ì§ˆë¬¸ë“¤ì„ ì²˜ë¦¬
                const processedQuestions = questionLines.map(line => {
                    const questionText = line.replace(/^\d+\.\s*/, '').trim();
                    
                    // [VISUAL: ...] íƒœê·¸ ì²˜ë¦¬
                    const visualMatch = questionText.match(/\[VISUAL:\s*([^\]]+)\]/);
                    if (visualMatch) {
                        const visualType = visualMatch[1].toLowerCase();
                        const cleanQuestion = questionText.replace(/\[VISUAL:[^\]]+\]/, '').trim();
                        
                        // ì‹œê°í™” ìš”ì†Œ ì¶”ê°€ ë¡œì§ì€ ë‚˜ì¤‘ì— displayQuestionì—ì„œ ì²˜ë¦¬
                        return {
                            text: cleanQuestion,
                            visual: visualType
                        };
                    }
                    
                    return {
                        text: questionText,
                        visual: null
                    };
                });
                
                return processedQuestions.map(q => q.text); // ì¼ë‹¨ í…ìŠ¤íŠ¸ë§Œ ë°˜í™˜ (ë‚˜ì¤‘ì— ì‹œê°í™” ì¶”ê°€)
                
            } catch (error) {
                console.error('GPT API Error:', error);
                throw error;
            }
        }

        // ì‹œê°í™” ìš”ì†Œë¥¼ í¬í•¨í•œ ì§ˆë¬¸ í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
        function displayQuestion() {
            setTimeout(() => {
                addQuestionDivider();
                
                const currentQuestion = questions[currentQuestionIndex];
                
                // ë¨¼ì € í…ìŠ¤íŠ¸ ì§ˆë¬¸ ì¶”ê°€
                addMessage(currentQuestion);
                
                // ì‹œê°í™” ìš”ì†Œ ê°ì§€ ë° ì¶”ê°€
                setTimeout(() => {
                    addVisualElementsForQuestion(currentQuestion);
                }, 500);
                
                waitingForAnswer = true;
            }, 500);
        }
        
        // ì§ˆë¬¸ì— ë§ëŠ” ì‹œê°í™” ìš”ì†Œ ì¶”ê°€
        function addVisualElementsForQuestion(questionText) {
            const chatMessages = document.getElementById('chatMessages');
            
            // ê¸°í•˜ ë¬¸ì œ ê°ì§€
            if (questionText.includes('ì‚¼ê°í˜•') || questionText.includes('triangle') || questionText.includes('ìš´ë™ì¥') && questionText.includes('ì§ì‚¬ê°í˜•')) {
                const visual = createMathVisual('geometry', { shape: 'triangle' });
                if (visual) {
                    chatMessages.appendChild(visual);
                    
                    // ì‹œê°ì  ì„¤ëª… ì¶”ê°€
                    const description = document.createElement('div');
                    description.className = 'visual-description';
                    description.textContent = 'ìœ„ ê·¸ë¦¼ì„ ì°¸ê³ í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ë³´ì„¸ìš”.';
                    chatMessages.appendChild(description);
                }
            }
            
            // í•¨ìˆ˜/ê·¸ë˜í”„ ë¬¸ì œ ê°ì§€
            if (questionText.includes('ê·¸ë˜í”„') || questionText.includes('í•¨ìˆ˜') || questionText.includes('ì˜¨ë„ ë³€í™”') || questionText.includes('y =')) {
                // ì¼ì°¨í•¨ìˆ˜ ì˜ˆì‹œ
                if (questionText.includes('y = -2x + 6')) {
                    const visual = createMathVisual('graph', { 
                        function: (x) => -2*x + 6 
                    });
                    if (visual) {
                        chatMessages.appendChild(visual);
                        
                        const description = document.createElement('div');
                        description.className = 'visual-description';
                        description.textContent = 'ìœ„ ê·¸ë˜í”„ëŠ” y = -2x + 6 í•¨ìˆ˜ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. xì¶•ê³¼ ë§Œë‚˜ëŠ” ì ì„ ì°¾ì•„ë³´ì„¸ìš”.';
                        chatMessages.appendChild(description);
                    }
                }
                
                // í¬ë¬¼ì„  í•¨ìˆ˜
                if (questionText.includes('h = -5t') || questionText.includes('ë†êµ¬ê³µ')) {
                    const visual = createMathVisual('graph', { 
                        function: (t) => -5*t*t + 10*t + 2 
                    });
                    if (visual) {
                        chatMessages.appendChild(visual);
                        
                        const description = document.createElement('div');
                        description.className = 'visual-description';
                        description.textContent = 'ìœ„ ê·¸ë˜í”„ëŠ” ê³µì˜ ë†’ì´ ë³€í™”ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ìµœê³ ì ê³¼ xì¶•ê³¼ì˜ êµì ì„ í™•ì¸í•´ë³´ì„¸ìš”.';
                        chatMessages.appendChild(description);
                    }
                }
            }
            
            // ê°œë… ì„¤ëª… ë°•ìŠ¤ ì¶”ê°€ (íŠ¹ì • í‚¤ì›Œë“œ ê°ì§€ì‹œ)
            if (questionText.includes('í”¼íƒ€ê³ ë¼ìŠ¤') || questionText.includes('ì§ê°ì‚¼ê°í˜•')) {
                const conceptVisual = createMathVisual('concept', {
                    title: 'í”¼íƒ€ê³ ë¼ìŠ¤ ì •ë¦¬',
                    content: 'ì§ê°ì‚¼ê°í˜•ì—ì„œ ë¹—ë³€ì˜ ì œê³±ì€ ë‘ ì§ê°ë³€ì˜ ì œê³±ì˜ í•©ê³¼ ê°™ìŠµë‹ˆë‹¤. cÂ² = aÂ² + bÂ²'
                });
                if (conceptVisual) {
                    chatMessages.appendChild(conceptVisual);
                }
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // GPT APIë¡œ í”¼ë“œë°± ìƒì„± (ê°œì„ ëœ ë²„ì „)
        async function generateFeedback(question, answer) {
            const prompt = `ë‹¹ì‹ ì€ ì¹œê·¼í•˜ê³  ì •í™•í•œ ìˆ˜í•™ ì„ ìƒë‹˜ì…ë‹ˆë‹¤. í•™ìƒì˜ ë‹µë³€ì„ ì •í™•í•˜ê²Œ ê²€í† í•œ í›„, **ì‹œê°ì  ì„¤ëª…ê³¼ í•¨ê»˜** ìì—°ìŠ¤ëŸ½ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ í”¼ë“œë°±ì„ ì£¼ì„¸ìš”.

**í•™ìƒì´ ë‹µí•œ ì§ˆë¬¸:** ${question}
**í•™ìƒ ë‹µë³€:** ${answer}

**ğŸ¯ ê°œì„ ëœ í”¼ë“œë°± ì§€ì¹¨:**
1. **ì‹œê°ì  ì„¤ëª… í¬í•¨**: ê°€ëŠ¥í•˜ë©´ ê·¸ë˜í”„, ë„í˜•, í‘œ ë“±ìœ¼ë¡œ ì„¤ëª…
2. **ë‹¨ê³„ë³„ í•´ì„¤**: ë³µì¡í•œ ê³¼ì •ì„ ì‘ì€ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ ì„¤ëª…
3. **ì‹¤ìƒí™œ ì—°ê²°**: í•´ë‹¹ ê°œë…ì´ ì‹¤ìƒí™œì—ì„œ ì–´ë–»ê²Œ ì“°ì´ëŠ”ì§€ ì–¸ê¸‰
4. **ê²©ë ¤ì™€ ë™ê¸°ë¶€ì—¬**: í•™ìƒì˜ ë…¸ë ¥ì„ ì¸ì •í•˜ê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ëŒê¸°
5. **ê°œë… ì´í•´ í™•ì¸**: ë‹¨ìˆœ ì •ë‹µ í™•ì¸ì„ ë„˜ì–´ ê°œë… ì´í•´ë„ í™•ì¸

**âœ… í”¼ë“œë°± êµ¬ì¡°:**
1. **ë‹µë³€ í‰ê°€**: ë§ëŠ”ì§€ í‹€ë ¸ëŠ”ì§€ ì¹œê·¼í•˜ê²Œ ì•Œë ¤ì£¼ê¸°
2. **í•µì‹¬ ê°œë… ì„¤ëª…**: ë¬¸ì œì™€ ê´€ë ¨ëœ ìˆ˜í•™ ê°œë… ê°„ë‹¨íˆ ì •ë¦¬
3. **ì‹œê°ì  íŒíŠ¸**: [VISUAL_HINT: ê·¸ë˜í”„/ë„í˜•/í‘œ] í˜•íƒœë¡œ ì‹œê°ì  ì„¤ëª… ì œì•ˆ
4. **ì‹¤ìƒí™œ ì—°ê²°**: ì´ ê°œë…ì´ ì¼ìƒì—ì„œ ì–´ë–»ê²Œ ì“°ì´ëŠ”ì§€
5. **ë‹¤ìŒ ë‹¨ê³„**: ë” ê¹Šì´ íƒêµ¬í•  ìˆ˜ ìˆëŠ” ë°©í–¥ ì œì‹œ

**ì‹œê°ì  ì„¤ëª… ì˜ˆì‹œ:**
- ê·¸ë˜í”„ ë¬¸ì œ: "ê·¸ë˜í”„ì—ì„œ ë³´ë©´ ì§ì„ ì´ xì¶•ê³¼ ë§Œë‚˜ëŠ” ì ì´ ë°”ë¡œ ë‹µì´ì—ìš”"
- ê¸°í•˜ ë¬¸ì œ: "ì‚¼ê°í˜•ì„ ê·¸ë ¤ë³´ë©´ ê°ì˜ ê´€ê³„ë¥¼ ì‰½ê²Œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”"  
- í•¨ìˆ˜ ë¬¸ì œ: "í¬ë¬¼ì„ ì˜ ê¼­ì§“ì ì´ ë°”ë¡œ ìµœëŒ“ê°’ì„ ë‚˜íƒ€ë‚´ëŠ” ì§€ì ì´ì—ìš”"

**âœ… ê²©ë ¤ ì¤‘ì‹¬ í†¤:**
- ë§ì„ ë•Œ: "ì •í™•í•´ìš”! ğŸ‘ [ê°œë… ì„¤ëª…] + [ì‹œê°ì  íŒíŠ¸] + [ì‹¤ìƒí™œ ì—°ê²°]"
- í‹€ë¦´ ë•Œ: "ì¢‹ì€ ì‹œë„ì˜€ì–´ìš”! ğŸ˜Š ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì ‘ê·¼í•´ë³¼ê¹Œìš”? [ë‹¨ê³„ë³„ í•´ì„¤] + [ì‹œê°ì  íŒíŠ¸]"

**ì˜ˆì‹œ (ì •ë‹µì¸ ê²½ìš°):**
"ë§ì•„ìš”! ì •ë§ ì˜í–ˆì–´ìš”! ğŸ‘ 

í”¼íƒ€ê³ ë¼ìŠ¤ ì •ë¦¬ë¥¼ ì •í™•íˆ ì ìš©í•˜ì…¨ë„¤ìš”. cÂ² = 60Â² + 40Â² = 3600 + 1600 = 5200ì´ë¯€ë¡œ c = âˆš5200 â‰ˆ 72.1mì…ë‹ˆë‹¤.

[VISUAL_HINT: ì§ì‚¬ê°í˜•ì—ì„œ ëŒ€ê°ì„ ì´ ë¹—ë³€ì¸ ì§ê°ì‚¼ê°í˜• ê·¸ë¦¼]

ì‹¤ìƒí™œì—ì„œë„ ì´ëŸ° ê³„ì‚°ì´ ì •ë§ ìœ ìš©í•´ìš”! ê±´ì¶•ê°€ë“¤ì´ ê±´ë¬¼ ì„¤ê³„í•  ë•Œë‚˜, ë‚´ë¹„ê²Œì´ì…˜ì´ ìµœë‹¨ê±°ë¦¬ë¥¼ ê³„ì‚°í•  ë•Œë„ ì´ ì›ë¦¬ë¥¼ ì‚¬ìš©í•œë‹µë‹ˆë‹¤. 

ë” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ë©´ ì–¸ì œë“  ë¬¼ì–´ë³´ì„¸ìš”!"

**ì˜ˆì‹œ (ì˜¤ë‹µì¸ ê²½ìš°):**
"ì¢‹ì€ ì‹œë„ì˜€ì–´ìš”! ğŸ˜Š ì¡°ê¸ˆ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì ‘ê·¼í•´ë³¼ê¹Œìš”?

ì´ ë¬¸ì œëŠ” í”¼íƒ€ê³ ë¼ìŠ¤ ì •ë¦¬ë¥¼ ì‚¬ìš©í•´ì•¼ í•´ìš”. ìš´ë™ì¥ì„ ì§ì‚¬ê°í˜•ìœ¼ë¡œ ìƒê°í•˜ë©´, ëŒ€ê°ì„ ì´ ë¹—ë³€ì´ ë˜ëŠ” ì§ê°ì‚¼ê°í˜•ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.

ë‹¨ê³„ë³„ë¡œ í•´ë³´ë©´:
1. ê°€ë¡œ 60m, ì„¸ë¡œ 40m
2. ëŒ€ê°ì„ Â² = 60Â² + 40Â²  
3. ëŒ€ê°ì„ Â² = 3600 + 1600 = 5200
4. ëŒ€ê°ì„  = âˆš5200 â‰ˆ 72.1m

[VISUAL_HINT: ì§ì‚¬ê°í˜•ê³¼ ëŒ€ê°ì„ ì„ í‘œì‹œí•œ ê·¸ë¦¼]

ì´ëŸ° ê³„ì‚°ì€ ì§€ë„ ì•±ì—ì„œ ìµœë‹¨ê±°ë¦¬ë¥¼ ì°¾ì„ ë•Œë„ ì‚¬ìš©ë¼ìš”!"

**âš ï¸ ì¤‘ìš”ì‚¬í•­:**
- í•­ìƒ ê²©ë ¤í•˜ëŠ” í†¤ ìœ ì§€
- ë³µì¡í•œ ê³„ì‚°ì€ ë‹¨ê³„ë³„ë¡œ ë‚˜ëˆ„ì–´ ì„¤ëª…
- ê°€ëŠ¥í•˜ë©´ [VISUAL_HINT: ...] í˜•íƒœë¡œ ì‹œê°ì  íŒíŠ¸ ì œê³µ
- ì‹¤ìƒí™œ ì—°ê²°ë¡œ í¥ë¯¸ ìœ ë°œ`;

            try {
                const response = await openai.chat_completions_create({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: 1000,
                    temperature: 0.7
                });

                const feedbackText = response.choices[0].message.content;
                
                // ì‹œê°ì  íŒíŠ¸ ì²˜ë¦¬
                setTimeout(() => {
                    addVisualHintsFromFeedback(feedbackText);
                }, 1000);

                return feedbackText;
                
            } catch (error) {
                console.error('GPT API Error:', error);
                throw error;
            }
        }
        
        // í”¼ë“œë°±ì—ì„œ ì‹œê°ì  íŒíŠ¸ ì¶”ê°€
        function addVisualHintsFromFeedback(feedbackText) {
            const chatMessages = document.getElementById('chatMessages');
            
            // [VISUAL_HINT: ...] íƒœê·¸ ê°ì§€
            const visualHintMatch = feedbackText.match(/\[VISUAL_HINT:\s*([^\]]+)\]/);
            if (visualHintMatch) {
                const hintType = visualHintMatch[1].toLowerCase();
                
                if (hintType.includes('ì§ì‚¬ê°í˜•') || hintType.includes('ì‚¼ê°í˜•')) {
                    const visual = createMathVisual('geometry', { shape: 'triangle' });
                    if (visual) {
                        chatMessages.appendChild(visual);
                    }
                } else if (hintType.includes('ê·¸ë˜í”„') || hintType.includes('í¬ë¬¼ì„ ')) {
                    const visual = createMathVisual('graph', { 
                        function: (x) => -0.5*x*x + 2*x + 1 
                    });
                    if (visual) {
                        chatMessages.appendChild(visual);
                    }
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // 2022 ê°œì • êµìœ¡ê³¼ì • ê¸°ë°˜ í•™ë…„ë³„ ê°œë… ë§¤í•‘
        const CURRICULUM_MAP = {
            // ì¤‘í•™êµ 1í•™ë…„
            'ì¤‘1': {
                concepts: ['ì •ìˆ˜ì™€ ìœ ë¦¬ìˆ˜', 'ë¬¸ìì™€ ì‹', 'ì¼ì°¨ë°©ì •ì‹', 'ì¢Œí‘œí‰ë©´', 'ê¸°ë³¸ë„í˜•', 'ì‘ë„', 'í†µê³„'],
                keywords: ['ì •ìˆ˜', 'ìœ ë¦¬ìˆ˜', 'ì ˆëŒ“ê°’', 'ë¬¸ìì‹', 'ì¼ì°¨ë°©ì •ì‹', 'ì¢Œí‘œ', 'ì ', 'ì§ì„ ', 'ê°', 'ì‚¼ê°í˜• ê¸°ì´ˆ', 'í‰ê· ', 'ë„ìˆ˜']
            },
            // ì¤‘í•™êµ 2í•™ë…„  
            'ì¤‘2': {
                concepts: ['ìœ ë¦¬ìˆ˜ì™€ ìˆœí™˜ì†Œìˆ˜', 'ì‹ì˜ ê³„ì‚°', 'ì¼ì°¨ë¶€ë“±ì‹', 'ì—°ë¦½ì¼ì°¨ë°©ì •ì‹', 'ì¼ì°¨í•¨ìˆ˜', 'ì‚¼ê°í˜•ì˜ ì„±ì§ˆ', 'ì‚¬ê°í˜•ì˜ ì„±ì§ˆ', 'ë„í˜•ì˜ ë‹®ìŒ'],
                keywords: ['ìˆœí™˜ì†Œìˆ˜', 'ë‹¨í•­ì‹', 'ë‹¤í•­ì‹', 'ë¶€ë“±ì‹', 'ì—°ë¦½ë°©ì •ì‹', 'ì¼ì°¨í•¨ìˆ˜', 'ê¸°ìš¸ê¸°', 'ì´ë“±ë³€ì‚¼ê°í˜•', 'ì§ê°ì‚¼ê°í˜•', 'í‰í–‰ì‚¬ë³€í˜•', 'ë‹®ìŒ']
            },
            // ì¤‘í•™êµ 3í•™ë…„
            'ì¤‘3': {
                concepts: ['ì œê³±ê·¼', 'ë‹¤í•­ì‹ì˜ ê³±ì…ˆ', 'ì¸ìˆ˜ë¶„í•´', 'ì´ì°¨ë°©ì •ì‹', 'ì´ì°¨í•¨ìˆ˜', 'í”¼íƒ€ê³ ë¼ìŠ¤ ì •ë¦¬', 'ì‚¼ê°ë¹„', 'ì›ì˜ ì„±ì§ˆ', 'í™•ë¥ '],
                keywords: ['ì œê³±ê·¼', 'ì¸ìˆ˜ë¶„í•´', 'ì´ì°¨ë°©ì •ì‹', 'ì´ì°¨í•¨ìˆ˜', 'í¬ë¬¼ì„ ', 'í”¼íƒ€ê³ ë¼ìŠ¤', 'ì‚¼ê°ë¹„', 'sin', 'cos', 'tan', 'ì›', 'í™•ë¥ ']
            },
            // ê³ ë“±í•™êµ 1í•™ë…„ (ìˆ˜í•™)
            'ê³ 1': {
                concepts: ['ë‹¤í•­ì‹', 'ë‚˜ë¨¸ì§€ì •ë¦¬', 'ì¸ìˆ˜ë¶„í•´', 'ë³µì†Œìˆ˜', 'ì´ì°¨ë°©ì •ì‹ê³¼ ì´ì°¨í•¨ìˆ˜', 'ì—¬ëŸ¬ ê°€ì§€ ë°©ì •ì‹', 'ì—¬ëŸ¬ ê°€ì§€ ë¶€ë“±ì‹', 'í‰ë©´ì¢Œí‘œ', 'ì§ì„ ì˜ ë°©ì •ì‹', 'ì›ì˜ ë°©ì •ì‹', 'ë„í˜•ì˜ ì´ë™'],
                keywords: ['ë³µì†Œìˆ˜', 'í—ˆìˆ˜', 'ì´ì°¨í•¨ìˆ˜ ìµœê°’', 'ì—°ë¦½ë°©ì •ì‹', 'ë¶€ë“±ì‹ ì˜ì—­', 'ì§ì„ ì˜ ë°©ì •ì‹', 'ì›ì˜ ë°©ì •ì‹', 'í‰í–‰ì´ë™', 'ëŒ€ì¹­ì´ë™']
            },
            // ê³ ë“±í•™êµ 2í•™ë…„ (ìˆ˜í•™I, ìˆ˜í•™II)
            'ê³ 2': {
                concepts: ['ì§€ìˆ˜í•¨ìˆ˜', 'ë¡œê·¸í•¨ìˆ˜', 'ì‚¼ê°í•¨ìˆ˜', 'ìˆ˜ì—´', 'í•¨ìˆ˜ì˜ ê·¹í•œ', 'ë¯¸ë¶„ë²•', 'ì ë¶„ë²•'],
                keywords: ['ì§€ìˆ˜', 'ë¡œê·¸', 'ì‚¼ê°í•¨ìˆ˜', 'ì£¼ê¸°í•¨ìˆ˜', 'ë“±ì°¨ìˆ˜ì—´', 'ë“±ë¹„ìˆ˜ì—´', 'ê·¹í•œ', 'ì—°ì†', 'ë¯¸ë¶„', 'ì ë¶„', 'ì •ì ë¶„']
            },
            // ê³ ë“±í•™êµ 3í•™ë…„ (ë¯¸ì ë¶„, ê¸°í•˜, í™•ë¥ ê³¼ í†µê³„)
            'ê³ 3': {
                concepts: ['ìˆ˜ì—´ì˜ ê·¹í•œ', 'í•¨ìˆ˜ì˜ ê·¹í•œê³¼ ì—°ì†', 'ë‹¤í•­í•¨ìˆ˜ì˜ ë¯¸ë¶„ë²•', 'ì‚¼ê°í•¨ìˆ˜ì˜ ë¯¸ë¶„ë²•', 'ì—¬ëŸ¬ í•¨ìˆ˜ì˜ ì ë¶„ë²•', 'ë²¡í„°', 'ê³µê°„ë„í˜•', 'í™•ë¥ ë¶„í¬', 'í†µê³„ì  ì¶”ì •'],
                keywords: ['ë¬´í•œê¸‰ìˆ˜', 'ì‚¼ê°í•¨ìˆ˜ ë¯¸ë¶„', 'ì—­í•¨ìˆ˜ ë¯¸ë¶„', 'ì¹˜í™˜ì ë¶„', 'ë¶€ë¶„ì ë¶„', 'ë²¡í„°', 'ì™¸ì ', 'í‰ë©´ì˜ ë°©ì •ì‹', 'ì •ê·œë¶„í¬', 'í‘œë³¸í‰ê· ']
            }
        };

        // ê°œë… ë¶„ì„ ë° í•™ë…„ ìˆ˜ì¤€ íŒì •
        function analyzeConceptLevel(concept) {
            const conceptLower = concept.toLowerCase();
            
            for (const [grade, data] of Object.entries(CURRICULUM_MAP)) {
                for (const keyword of data.keywords) {
                    if (conceptLower.includes(keyword.toLowerCase())) {
                        return {
                            grade: grade,
                            level: grade,
                            appropriateAge: getAgeRange(grade),
                            concepts: data.concepts
                        };
                    }
                }
            }
            
            // ê¸°ë³¸ê°’: ì¤‘3 ìˆ˜ì¤€ìœ¼ë¡œ ì„¤ì •
            return {
                grade: 'ì¤‘3',
                level: 'ì¤‘3',
                appropriateAge: '15-16ì„¸',
                concepts: CURRICULUM_MAP['ì¤‘3'].concepts
            };
        }

        // í•™ë…„ë³„ ì—°ë ¹ëŒ€ ë§¤í•‘
        function getAgeRange(grade) {
            const ageMap = {
                'ì¤‘1': '13-14ì„¸',
                'ì¤‘2': '14-15ì„¸', 
                'ì¤‘3': '15-16ì„¸',
                'ê³ 1': '16-17ì„¸',
                'ê³ 2': '17-18ì„¸',
                'ê³ 3': '18-19ì„¸'
            };
            return ageMap[grade] || '15-16ì„¸';
        }

        // ê°œë… ì¶©ëŒ ë°©ì§€ ë° ë‚œì´ë„ ì¡°ì ˆ
        function validateConceptDifficulty(userConcept, questionConcept) {
            const userLevel = analyzeConceptLevel(userConcept);
            const questionLevel = analyzeConceptLevel(questionConcept);
            
            // í•™ë…„ ìˆ˜ì¤€ ë¹„êµ (ì¤‘1=1, ì¤‘2=2, ì¤‘3=3, ê³ 1=4, ê³ 2=5, ê³ 3=6)
            const levelMap = { 'ì¤‘1': 1, 'ì¤‘2': 2, 'ì¤‘3': 3, 'ê³ 1': 4, 'ê³ 2': 5, 'ê³ 3': 6 };
            const userGradeNum = levelMap[userLevel.grade] || 3;
            const questionGradeNum = levelMap[questionLevel.grade] || 3;
            
            return {
                isAppropriate: questionGradeNum <= userGradeNum + 1, // 1í•™ë…„ ìœ„ê¹Œì§€ëŠ” í—ˆìš©
                userLevel: userLevel,
                questionLevel: questionLevel,
                recommendation: generateDifficultyRecommendation(userGradeNum, questionGradeNum)
            };
        }

        // ë‚œì´ë„ ì¡°ì ˆ ê¶Œì¥ì‚¬í•­ ìƒì„±
        function generateDifficultyRecommendation(userGrade, questionGrade) {
            if (questionGrade > userGrade + 1) {
                return `ë¬¸ì œê°€ ë„ˆë¬´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ${CURRICULUM_MAP[Object.keys(CURRICULUM_MAP)[userGrade-1]]?.concepts.join(', ')} ìˆ˜ì¤€ì˜ ë¬¸ì œë¡œ ì¡°ì •í•˜ëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤.`;
            } else if (questionGrade < userGrade - 1) {
                return `ë¬¸ì œê°€ ë„ˆë¬´ ì‰¬ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¢€ ë” ë„ì „ì ì¸ ë¬¸ì œë¥¼ ì œì‹œí•´ë³´ì„¸ìš”.`;
            } else {
                return `ì ì ˆí•œ ë‚œì´ë„ì…ë‹ˆë‹¤.`;
            }
        }

        // êµìœ¡ê³¼ì • ê¸°ë°˜ ë¬¸ì œ í•„í„°ë§ ë° ê°œì„  í•¨ìˆ˜
        function enhanceQuestionWithCurriculum(concept, questions) {
            const conceptAnalysis = analyzeConceptLevel(concept);
            
            // ê°œë… ë°•ìŠ¤ ì¶”ê°€
            const conceptBox = createMathVisual('concept', {
                title: `ğŸ“š ${conceptAnalysis.grade} ìˆ˜ì¤€ í•™ìŠµ`,
                content: `í˜„ì¬ í•™ìŠµ ì¤‘ì¸ ê°œë…ë“¤: ${conceptAnalysis.concepts.join(', ')}\nì ì • ì—°ë ¹ëŒ€: ${conceptAnalysis.appropriateAge}`
            });
            
            if (conceptBox) {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.appendChild(conceptBox);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            return {
                analysis: conceptAnalysis,
                filteredQuestions: questions, // ì¼ë‹¨ ëª¨ë“  ì§ˆë¬¸ í†µê³¼ (AIê°€ ì ì ˆíˆ ìƒì„±í–ˆë‹¤ê³  ê°€ì •)
                recommendations: [
                    `${conceptAnalysis.grade} ìˆ˜ì¤€ì— ë§ëŠ” ê°œë… ì´í•´ ì¤‘ì‹¬ ë¬¸ì œì…ë‹ˆë‹¤.`,
                    `ì‹¤ìƒí™œ ì—°ê²°ê³¼ ì‹œê°ì  ì´í•´ë¥¼ ì¤‘ì ìœ¼ë¡œ í•™ìŠµí•´ë³´ì„¸ìš”.`,
                    `ë‹¨ê³„ì  ì‚¬ê³ ë¥¼ í†µí•´ ê¹Šì´ ìˆê²Œ íƒêµ¬í•´ë³´ì„¸ìš”.`
                ]
            };
        }

        // íŒŒì¼ì„ Base64ë¡œ ë³€í™˜
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // í…ìŠ¤íŠ¸ ì˜ì—­ ë†’ì´ ìë™ ì¡°ì ˆ
        function adjustTextareaHeight() {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 100) + 'px';
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            // ì €ì¥ëœ API í‚¤ í™•ì¸
            const savedApiKey = localStorage.getItem('openai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKeyInput').value = savedApiKey;
                apiKey = savedApiKey;
                openai = new OpenAIClient(savedApiKey);
                apiModal.style.display = 'none';
                addWelcomeMessages();
            }

            // ì „ì†¡ ë²„íŠ¼ í´ë¦­
            sendButton.addEventListener('click', function() {
                if (!isProcessingMessage) {
                    sendMessage();
                }
            });

            // í•œê¸€ ì…ë ¥ê¸°(IME) ì´ë²¤íŠ¸ ì²˜ë¦¬
            chatInput.addEventListener('compositionstart', function(e) {
                isComposing = true;
            });

            chatInput.addEventListener('compositionend', function(e) {
                isComposing = false;
                // composition ì™„ë£Œ í›„ ìì—°ìŠ¤ëŸ½ê²Œ ì²˜ë¦¬ (ê°’ ë®ì–´ì“°ê¸° ì œê±°)
            });

            // ì—”í„° í‚¤ ì „ì†¡ (Shift+EnterëŠ” ì¤„ë°”ê¿ˆ)
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && !isProcessingMessage && !isComposing) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // í…ìŠ¤íŠ¸ ì˜ì—­ ë†’ì´ ìë™ ì¡°ì ˆ
            chatInput.addEventListener('input', adjustTextareaHeight);

            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼
            imageButton.addEventListener('click', function() {
                imageInput.click();
            });

            // ì´ë¯¸ì§€ ì„ íƒ ì´ë²¤íŠ¸
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            });

            // API í‚¤ ì…ë ¥ì—ì„œ ì—”í„° í‚¤
            document.getElementById('apiKeyInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    setApiKey();
                }
            });
        });
    </script>
</body>
</html>